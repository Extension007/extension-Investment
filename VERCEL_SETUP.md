# Настройка Vercel для проекта с MongoDB

## Проблемы с подключением к базе данных в продакшн

### Причины проблем:

1. **Неправильные переменные окружения в Vercel**
2. **Ограничения Network Access в MongoDB Atlas**
3. **Неправильные настройки таймаутов**
4. **Проблемы с аутентификацией**

### Решения:

#### 1. Настройка переменных окружения в Vercel

В Vercel Dashboard перейдите в Settings → Environment Variables и добавьте:

```
MONGODB_URI=mongodb+srv://username:password@cluster.mongodb.net/database?retryWrites=true&w=majority
SESSION_SECRET=your-secret-key-here
NODE_ENV=production
```

#### 2. Настройка Network Access в MongoDB Atlas

1. Зайдите в MongoDB Atlas Dashboard
2. Перейдите в Security → Network Access
3. Нажмите "Add IP Address"
4. Для тестирования добавьте IP: `0.0.0.0/0` (разрешает все IP)
5. Для продакшна добавьте IP-адреса Vercel (можно найти в документации Vercel)

#### 3. Проверка подключения

Для диагностики используйте скрипты:

```bash
# Проверка локального подключения
node scripts/diagnose-db.js

# Проверка Vercel подключения
node scripts/check-vercel-db.js
```

#### 4. Улучшенные настройки для Vercel

В `config/database.js` добавлены специальные настройки для Vercel:

- Увеличенные таймауты подключения
- Оптимизированный размер пула соединений
- Детальная диагностика ошибок
- Автоматическое переподключение

#### 5. Рекомендации

1. **Используйте mongodb+srv:// URI** - автоматически выбирает доступный сервер
2. **Увеличьте таймауты** - Vercel может иметь более высокую задержку
3. **Ограничьте размер пула** - Vercel имеет ограниченные ресурсы
4. **Включите retryWrites** - автоматическое повторение операций при ошибках
5. **Мониторьте логи** - используйте Vercel Logs для диагностики

#### 6. Типичные ошибки и решения

| Ошибка | Причина | Решение |
|--------|---------|---------|
| `authentication failed` | Неверный username/password | Проверьте URI в Vercel Environment Variables |
| `timeout` | Network Access не настроен | Добавьте IP в MongoDB Atlas Network Access |
| `ENOTFOUND` | Неверный hostname | Скопируйте URI напрямую из MongoDB Atlas |
| `ECONNREFUSED` | Сервер недоступен | Проверьте статус кластера в MongoDB Atlas |

#### 7. Тестирование

После настройки:
1. Перезапустите деплой в Vercel
2. Проверьте логи в Vercel Dashboard
3. Убедитесь, что приложение подключается к базе данных
4. Протестируйте основные функции (регистрация, вход, добавление товаров)

### Автоматическая диагностика

Проект включает автоматическую диагностику подключения к базе данных:
- Детальные логи ошибок
- Автоматическое определение типа ошибки
- Рекомендации по решению проблем
- Мониторинг состояния подключения
