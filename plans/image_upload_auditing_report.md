# Технический аудит системы загрузки изображений

## Обзор проблемы
В ходе аудита было выявлено несколько критических и значительных проблем в системе загрузки и отображения изображений, особенно связанных с работой на мобильных устройствах и в браузерах с активными системами отслеживания (Tracking Prevention).

## 1. Backend: маршруты и middleware

### Проблемы:

#### 1.1 req.skipImageUpload на мобильных устройствах
- **Файл:** `utils/upload.js`
- **Строка:** 33-149
- **Проблема:** В `createImageUpload` для мобильных пользователей без Cloudinary ставится `req.skipImageUpload = true`.
- **Риск:** Даже если Cloudinary доступен, инициализация может падать из-за неверных env-переменных, и upload пропускается.
- **Результат:** `req.files = []` → карточка создается без изображений.

#### 1.2 Cloudinary не инициализируется при ошибках require
- **Файл:** `utils/upload.js`
- **Строка:** 51-53
- **Проблема:** Ошибки `require("multer-storage-cloudinary")` или `require("cloudinary").v2` приводят к пропуску загрузки.
- **Риск:** Особенно критично на мобильных устройствах, так как ветка fallback сразу делает `req.skipImageUpload = true`.

#### 1.3 Обработка ошибок Multer
- **Файл:** `routes/cabinet.js`
- **Строка:** 21-40
- **Проблема:** Ошибки multer обрабатываются в `handleMulterError`, но она не используется в маршрутах `/cabinet/product` и `/cabinet/banner`.
- **Риск:** Ошибки по типу `LIMIT_FILE_SIZE` или `LIMIT_FILE_COUNT` могут приводить к silent fail — карточка создается без картинки, но без видимого сообщения пользователю.

#### 1.4 Soft delete и редактирование
- **Файл:** `services/productService.js`
- **Строка:** 147-166
- **Проблема:** У карточек с `deleted = true` изображения остаются в Cloudinary → потенциальный мусор.
- **Риск:** При редактировании проверка `req.body.current_images` иногда не синхронизируется с `banner.images`, из-за чего первая картинка (`image_url`) может быть null.

#### 1.5 Проверка CSRF и conditionalCsrfToken
- **Файл:** `routes/cabinet.js`
- **Строка:** 18-19
- **Проблема:** На Vercel CSRF отключен (`conditionalCsrfProtection`), но EJS формы ожидают токен `csrfToken`.
- **Риск:** В мобильных AJAX-запросах токен может быть undefined → Multer может не пройти middleware.

## 2. Cloudinary

### Проблемы:

#### 2.1 Tracking Prevention блокирует загрузку изображений
- **Файл:** `views/partials/card.ejs`
- **Строка:** 104-113
- **Проблема:** Safari, Firefox и Chrome с Enhanced Tracking Prevention блокируют доступ к `res.cloudinary.com`.
- **Риск:** Из-за этого `<img>` на фронтенде не загружается → кажется, что карточка без картинки.

#### 2.2 CORS и URL форматы
- **Файл:** `services/imageService.js`
- **Строка:** 35-63
- **Проблема:** В Cloudinary URL есть `?_a=BAMAMifm0` — иногда Safari воспринимает как трекер.
- **Риск:** Решение: использовать fetch format auto и безопасные URL (`f_auto,q_auto,c_limit`).

#### 2.3 Мобильная ветка без Cloudinary
- **Файл:** `utils/upload.js`
- **Строка:** 85-94
- **Проблема:** Если пользователь мобильный, а Cloudinary недоступен, изображения не загружаются.
- **Риск:** В коде нет fallback на локальное хранение (`uploads/`).

## 3. Frontend (EJS)

### Проблемы:

#### 3.1 img src="{{image_url}}" ломается при Tracking Prevention
- **Файл:** `views/partials/card.ejs`
- **Строка:** 104-113
- **Проблема:** `<img src="{{image_url}}">` ломается при Tracking Prevention → пустое место вместо картинки.
- **Риск:** Нет проверки `req.skipImageUpload` → форма визуально кажется, что изображение загружено, но файл не попал на Cloudinary.

#### 3.2 AJAX-запросы на создание/редактирование не показывают ошибки загрузки файлов
- **Файл:** `views/cabinet.ejs`
- **Строка:** 256-323
- **Проблема:** AJAX-запросы не отображают пользователю конкретные ошибки загрузки файлов.
- **Риск:** Пользователь не понимает, почему карточка создалась без изображений.

## 4. Конфигурация

### Проблемы:

#### 4.1 .env переменные Cloudinary заданы верно, но нет проверки, что Cloudinary реально отвечает
- **Файл:** `utils/upload.js`
- **Строка:** 38-42
- **Проблема:** Нет проверки соединения с Cloudinary.
- **Риск:** Если Cloudinary недоступен, система может использовать fallback, даже если основной сервис работает.

#### 4.2 NODE_ENV=development → на Vercel ветка CSRF отключена
- **Файл:** `config/app.js`
- **Строка:** 88-91
- **Проблема:** На Vercel CSRF отключен, что может приводить к silent fail.
- **Риск:** Возможны проблемы с безопасностью и совместимостью.

## 5. Логирование и обработка ошибок

### Проблемы:

#### 5.1 Multer и Cloudinary логируют ошибки, но не возвращают пользователю конкретные сообщения
- **Файл:** `utils/upload.js`
- **Строка:** 114-124
- **Проблема:** Логи показывают ошибки, но пользователь не получает конкретной информации.
- **Риск:** Пользователь не знает, почему загрузка не удалась.

#### 5.2 В мобильной ветке при failed upload нет уведомления
- **Файл:** `utils/upload.js`
- **Строка:** 85-94
- **Проблема:** Карточка создается без изображений, пользователь не получает уведомления.
- **Риск:** Silent fail, снижение качества UX.

#### 5.3 Логи слишком verbose (console.log)
- **Файл:** `utils/upload.js`
- **Строка:** 44, 73, 107, 131
- **Проблема:** Используются простые console.log вместо полноценной системы логирования.
- **Риск:** На production стоит использовать Winston/Log4js.

## Рекомендации по исправлению

### 1. Исправить createImageUpload
- Всегда инициализировать локальное хранилище как fallback.
- Проверять Cloudinary connection через `cloudinary.api.ping()` перед пропуском загрузки.
- Для мобильных: если Cloudinary недоступен — использовать локальное хранилище вместо skipImageUpload.

### 2. Обработка ошибок Multer
- Использовать `handleMulterError` в маршрутах `/product` и `/banner`.
- Возвращать JSON с конкретной ошибкой для пользователя.

### 3. Tracking Prevention
- Добавить серверный прокси для Cloudinary URL → `<img src="/cdn/products/...">`, чтобы обходить блокировку трекеров.
- Альтернативно, включить локальный fallback (`uploads/`) и отдавать изображения с сервера.

### 4. Фронтенд
- Добавить проверку `product.image_url` перед рендером.
- Показать placeholder, если изображение не загружено.

## Тест-кейсы после исправления

| Сценарий | Ожидаемый результат |
|----------|---------------------|
| Создание карточки на desktop с изображением | Карточка создается, изображение появляется на Cloudinary и в EJS |
| Создание карточки на mobile с изображением | Карточка создается, изображение либо на Cloudinary, либо на локальном сервере |
| AJAX-запрос создания без изображения | Ошибка возвращается пользователю, карточка не создается |
| Редактирование карточки | Сохраняются новые и старые изображения, image_url корректно выставлен |
| Удаление карточки | Soft delete, изображения удаляются, уведомление администратору отправлено |
| Баннер с 1 изображением | Карточка создается, отображение корректное на всех браузерах |

## Заключение
Основные проблемы связаны с неправильной обработкой загрузки изображений на мобильных устройствах, отсутствием надежного fallback механизма и недостаточной обработкой ошибок. Рекомендуется внедрить комплексное решение, включающее проверку Cloudinary, надежный fallback на локальное хранилище и улучшенную обработку ошибок.