<% 
  /**
   * –£–Ω–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —à–∞–±–ª–æ–Ω –∫–∞—Ä—Ç–æ—á–∫–∏ –¥–ª—è –≤—Å–µ—Ö —Ç–∏–ø–æ–≤ (—Ç–æ–≤–∞—Ä—ã, —É—Å–ª—É–≥–∏, –±–∞–Ω–Ω–µ—Ä—ã)
   * 
   * –ü–∞—Ä–∞–º–µ—Ç—Ä—ã:
   * - product, service, banner: –æ–±—ä–µ–∫—Ç –∫–∞—Ä—Ç–æ—á–∫–∏ (–æ–¥–∏–Ω –∏–∑ –Ω–∏—Ö –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –ø–µ—Ä–µ–¥–∞–Ω)
   * - itemType: —è–≤–Ω–æ —É–∫–∞–∑–∞–Ω–Ω—ã–π —Ç–∏–ø ('product', 'service', 'banner')
   * - mode: —Ä–µ–∂–∏–º –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è ('admin', 'user', 'public')
   * - user: –æ–±—ä–µ–∫—Ç —Ç–µ–∫—É—â–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (–¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –≤–ª–∞–¥–µ–ª—å—Ü–∞)
   * 
   * –ò—Å–ø–æ–ª—å–∑—É–µ—Ç –ª–æ–∫–∞–ª—å–Ω—É—é –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é 'type' –≤–º–µ—Å—Ç–æ 'itemType', —á—Ç–æ–±—ã –Ω–µ –ø–µ—Ä–µ–æ–ø—Ä–µ–¥–µ–ª—è—Ç—å –ø–∞—Ä–∞–º–µ—Ç—Ä
   */
  
  // –£–Ω–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –¥–ª—è –≤—Å–µ—Ö —Ç–∏–ø–æ–≤ –∫–∞—Ä—Ç–æ—á–µ–∫
  const item = typeof product !== 'undefined' ? product : (typeof service !== 'undefined' ? service : banner);
  
  // –ò—Å–ø–æ–ª—å–∑—É–µ–º –ø–µ—Ä–µ–¥–∞–Ω–Ω—ã–π itemType –∏–ª–∏ –æ–ø—Ä–µ–¥–µ–ª—è–µ–º –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ (–∏—Å–ø–æ–ª—å–∑—É–µ–º type –≤–º–µ—Å—Ç–æ itemType, —á—Ç–æ–±—ã –Ω–µ –ø–µ—Ä–µ–æ–ø—Ä–µ–¥–µ–ª—è—Ç—å –ø–∞—Ä–∞–º–µ—Ç—Ä)
  const type = (typeof itemType !== 'undefined')
    ? itemType
    : (typeof product !== 'undefined' ? 'product' : (typeof service !== 'undefined' ? 'service' : 'banner'));
  const itemId = item._id.toString();
  const itemName = item.name || item.title || `–ö–∞—Ä—Ç–æ—á–∫–∞ ${itemId.substring(0, 8)}`;
  const itemDescription = item.description || '';
  const itemPrice = item.price || 0;
  const itemLink = item.link || '';
  const itemVideoUrl = item.video_url || '';
  const itemCategory = item.category || '';
  const itemStatus = item.status || 'pending';
  const itemOwner = item.owner || null;
  const itemImages = item.images || [];
  const itemImageUrl = item.image_url || (itemImages.length > 0 ? itemImages[0] : null);
  
  // –ö–æ–Ω—Ç–∞–∫—Ç—ã (–¥–ª—è —Ç–æ–≤–∞—Ä–æ–≤ –∏ —É—Å–ª—É–≥)
  const contacts = item.contacts || {};
  const phone = contacts.phone || '';
  const email = contacts.email || '';
  const telegram = contacts.telegram || '';
  const whatsapp = contacts.whatsapp || '';
  const contactMethod = contacts.contact_method || '';
  
  // –†–µ–π—Ç–∏–Ω–≥ (—Ä–∞–∑–Ω—ã–µ –ø–æ–ª—è –¥–ª—è —Ä–∞–∑–Ω—ã—Ö —Ç–∏–ø–æ–≤)
  const ratingUp = item.rating_up || item.likes || 0;
  const ratingDown = item.rating_down || item.dislikes || 0;
  const ratingResult = ratingUp - ratingDown;
  const ratingTotal = ratingUp + ratingDown;
  
  // –†–µ–∂–∏–º –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è (admin, user, public)
  const displayMode = typeof mode !== 'undefined' ? mode : 'public';
  const isAdmin = displayMode === 'admin';
  const isUser = displayMode === 'user';
  const isPublic = displayMode === 'public';
  
  // –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤–ª–∞–¥–µ–ª—å—Ü–∞ (–¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–æ–≥–æ —Ä–µ–∂–∏–º–∞)
  const isOwner = isUser && itemOwner && typeof user !== 'undefined' && user && user._id && itemOwner.toString() === user._id.toString();
  const canEdit = isAdmin || isOwner;
  const canDelete = isAdmin || isOwner;
  
  // CSS –∫–ª–∞—Å—Å—ã –¥–ª—è –∫–∞—Ä—Ç–æ—á–∫–∏
  const cardClass = displayMode === 'admin' ? 'catalog-item' : 'product-card';
  const cardDataAttr = `data-${type}-id="${itemId}"`;
%>

<div class="<%= cardClass %>" <%= cardDataAttr %>>
  <!-- –°—Ç–∞—Ç—É—Å –∫–∞—Ä—Ç–æ—á–∫–∏ -->
  <% if (isAdmin || isUser) { %>
    <div class="item-status-container">
      <% if (itemStatus === 'published' || itemStatus === 'approved') { %>
        <span class="item-status status-published">‚úÖ –û–ø—É–±–ª–∏–∫–æ–≤–∞–Ω–æ</span>
      <% } else if (itemStatus === 'blocked' || itemStatus === 'rejected') { %>
        <span class="item-status status-blocked">üö´ <%= itemStatus === 'rejected' ? '–û—Ç–∫–ª–æ–Ω–µ–Ω–æ' : '–ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–æ' %></span>
        <% if (item.rejection_reason) { %>
          <p class="rejection-reason" style="color:#f44336;font-size:0.85rem;margin-top:5px;"><%= item.rejection_reason %></p>
        <% } %>
      <% } else if (itemStatus === 'draft') { %>
        <span class="item-status status-draft">‚è≥ –ß–µ—Ä–Ω–æ–≤–∏–∫</span>
      <% } else { %>
        <span class="item-status status-pending">‚è≥ –ù–∞ –º–æ–¥–µ—Ä–∞—Ü–∏–∏</span>
      <% } %>
    </div>
  <% } %>

  <!-- –ù–∞–∑–≤–∞–Ω–∏–µ -->
  <h3 class="item-title"><%= itemName %></h3>

  <!-- –û–ø–∏—Å–∞–Ω–∏–µ (–∫—Ä–∞—Ç–∫–æ–µ) -->
  <% if (itemDescription) { %>
    <p class="item-description">
      <%= itemDescription.length > 100 ? itemDescription.substring(0, 100) + '...' : itemDescription %>
    </p>
  <% } %>

  <!-- –ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è -->
  <% if (itemImages && itemImages.length > 0) { %>
    <div class="item-images">
      <% itemImages.slice(0, 3).forEach((img, idx) => { %>
        <img src="<%= img %>" alt="<%= itemName %>" loading="lazy">
      <% }) %>
      <% if (itemImages.length > 3) { %>
        <span class="images-count">+<%= itemImages.length - 3 %> –µ—â–µ</span>
      <% } %>
    </div>
  <% } else if (itemImageUrl) { %>
    <div class="item-images">
      <img src="<%= itemImageUrl %>" alt="<%= itemName %>" loading="lazy">
    </div>
  <% } %>

  <!-- –ú–µ—Ç–∞-–∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è -->
  <div class="item-meta">
    <% if (itemLink) { %>
      <p class="meta-link">
        <span class="meta-label">–°—Å—ã–ª–∫–∞:</span>
        <a href="<%= itemLink %>" target="_blank" rel="noopener" class="item-link">
          <%= itemLink.length > 30 ? itemLink.substring(0, 30) + '...' : itemLink %>
        </a>
      </p>
    <% } %>

    <% if (itemVideoUrl) { %>
      <p class="meta-video">
        <span class="meta-label">–í–∏–¥–µ–æ:</span>
        <button class="btn-video-link" data-video="<%= itemVideoUrl %>" type="button">
          ‚ñ∂Ô∏è <%= itemVideoUrl.length > 30 ? itemVideoUrl.substring(0, 30) + '...' : itemVideoUrl %>
        </button>
      </p>
    <% } %>

    <% if (isAdmin && itemOwner) { %>
      <p class="meta-owner">
        <span class="meta-label">–í–ª–∞–¥–µ–ª–µ—Ü:</span>
        <%= itemOwner.username || itemOwner.email || 'Admin' %>
      </p>
    <% } %>

    <% if (itemCategory) { %>
      <p class="meta-category">
        <span class="meta-label">–ö–∞—Ç–µ–≥–æ—Ä–∏—è:</span>
        <%= itemCategory %>
      </p>
    <% } %>

    <!-- –ö–æ–Ω—Ç–∞–∫—Ç—ã (–¥–ª—è —Ç–æ–≤–∞—Ä–æ–≤ –∏ —É—Å–ª—É–≥) -->
    <% if ((type === 'product' || type === 'service') && (phone || email || telegram || whatsapp || contactMethod)) { %>
      <div class="item-contacts">
        <% if (phone) { %>
          <p class="contact-item">
            <span class="meta-label">–¢–µ–ª–µ—Ñ–æ–Ω:</span>
            <a href="tel:<%= phone %>"><%= phone %></a>
          </p>
        <% } %>
        <% if (email) { %>
          <p class="contact-item">
            <span class="meta-label">Email:</span>
            <a href="mailto:<%= email %>"><%= email %></a>
          </p>
        <% } %>
        <% if (telegram) { %>
          <p class="contact-item">
            <span class="meta-label">Telegram:</span>
            <a href="https://t.me/<%= telegram.replace('@', '') %>" target="_blank" rel="noopener"><%= telegram %></a>
          </p>
        <% } %>
        <% if (whatsapp) { %>
          <p class="contact-item">
            <span class="meta-label">WhatsApp:</span>
            <a href="https://wa.me/<%= whatsapp.replace(/[^0-9]/g, '') %>" target="_blank" rel="noopener"><%= whatsapp %></a>
          </p>
        <% } %>
        <% if (contactMethod) { %>
          <p class="contact-method">
            <span class="meta-label">–°–ø–æ—Å–æ–± —Å–≤—è–∑–∏:</span>
            <span class="contact-method-text"><%= contactMethod %></span>
          </p>
        <% } %>
      </div>
    <% } %>

    <!-- –¶–µ–Ω–∞ -->
    <% if (itemPrice > 0) { %>
      <p class="item-price">
        <span class="meta-label">–¶–µ–Ω–∞:</span>
        <strong><%= itemPrice %> ‚Ç∏</strong>
      </p>
    <% } %>
  </div>

  <!-- –†–µ–π—Ç–∏–Ω–≥ (–≥–æ–ª–æ—Å–æ–≤–∞–Ω–∏–µ) -->
  <div class="item-rating <%= type %>-rating" data-id="<%= itemId %>" data-type="<%= type %>" data-voted="false">
    <button class="<%= type %>-like-btn btn-rating" type="button" aria-label="–õ–∞–π–∫">‚ñ≤</button>
    <span class="<%= type %>-result rating-result" style="font-weight: 600;"><%= ratingResult %></span>
    <button class="<%= type %>-dislike-btn btn-rating" type="button" aria-label="–î–∏–∑–ª–∞–π–∫">‚ñº</button>
    <span class="<%= type %>-votes rating-votes" style="color: #666; font-size: 0.85rem;">
      (<%= ratingTotal %> –≥–æ–ª–æ—Å–æ–≤)
    </span>
  </div>

  <!-- –î–µ–π—Å—Ç–≤–∏—è -->
  <div class="item-actions">
    <% if (isAdmin) { %>
      <!-- –ê–¥–º–∏–Ω—Å–∫–∏–µ –¥–µ–π—Å—Ç–≤–∏—è -->
      <% if (itemStatus === 'published' || itemStatus === 'approved') { %>
        <button class="block-<%= type %>-btn btn-block" data-id="<%= itemId %>" type="button">üö´ –ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å</button>
      <% } else { %>
        <button class="publish-<%= type %>-btn btn-publish" data-id="<%= itemId %>" type="button">‚úÖ –û–ø—É–±–ª–∏–∫–æ–≤–∞—Ç—å</button>
      <% } %>
      <button class="edit-<%= type %>-btn btn-edit btn-outline" data-id="<%= itemId %>" type="button">‚úèÔ∏è –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</button>
      <button class="delete-<%= type %>-btn btn-delete" data-id="<%= itemId %>" type="button">üóëÔ∏è –£–¥–∞–ª–∏—Ç—å</button>
    <% } else if (isUser && isOwner) { %>
      <!-- –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–µ –¥–µ–π—Å—Ç–≤–∏—è (—Ç–æ–ª—å–∫–æ –¥–ª—è —Å–≤–æ–∏—Ö –∫–∞—Ä—Ç–æ—á–µ–∫) -->
      <button class="edit-<%= type %>-btn btn-edit btn-outline" data-id="<%= itemId %>" type="button">‚úèÔ∏è –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</button>
      <button class="delete-<%= type %>-btn btn-delete" data-id="<%= itemId %>" type="button">üóëÔ∏è –£–¥–∞–ª–∏—Ç—å</button>
      <% if (itemLink) { %>
        <a class="btn-link btn-outline" href="<%= itemLink %>" target="_blank" rel="noopener">üîó –°—Å—ã–ª–∫–∞</a>
      <% } %>
  <% } else if (isPublic) { %>
    <!-- –ü—É–±–ª–∏—á–Ω—ã–µ –¥–µ–π—Å—Ç–≤–∏—è (—Å—Å—ã–ª–∫–∏ –∏ —á–∞—Ç –¥–ª—è –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π) -->
    <% if (itemLink) { %>
      <a class="btn-link btn-outline" href="<%= itemLink %>" target="_blank" rel="noopener">–ü–µ—Ä–µ–π—Ç–∏</a>
    <% } %>
    <% if (typeof user !== 'undefined' && user) { %>
      <button class="chat-btn btn-outline" data-card-id="<%= itemId %>" type="button">üí¨ –ß–∞—Ç</button>
    <% } %>
  <% } %>
  </div>

  <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —á–∞—Ç–∞ -->
  <div class="chat-modal" id="chat-modal-<%= itemId %>" style="display: none;">
    <div class="chat-modal-overlay" onclick="closeChatModal('<%= itemId %>')"></div>
    <div class="chat-modal-content">
      <div class="chat-modal-header">
        <h3>–ß–∞—Ç –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤</h3>
        <button class="chat-close-btn" onclick="closeChatModal('<%= itemId %>')" type="button">√ó</button>
      </div>
      <div class="chat-messages" id="chat-messages-<%= itemId %>">
        <!-- –°–æ–æ–±—â–µ–Ω–∏—è –±—É–¥—É—Ç –∑–∞–≥—Ä—É–∂–∞—Ç—å—Å—è –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ -->
      </div>
      <div class="chat-input-container">
        <textarea
          class="chat-input"
          id="chat-input-<%= itemId %>"
          placeholder="–í–≤–µ–¥–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ..."
          maxlength="1000"
          rows="2"
        ></textarea>
        <button class="chat-send-btn" onclick="sendChatMessage('<%= itemId %>')" type="button">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
      </div>
    </div>
  </div>
</div>
