<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title><%= mode === 'admin' ? '–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞ (–ê–¥–º–∏–Ω)' : '–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å —Ç–æ–≤–∞—Ä' %></title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="csrf-token" content="<%= csrfToken %>">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="/styles.css">
</head>
<body>
  <header class="main-header">
    <div class="container header-inner">
      <a class="logo" href="/">EXTO</a>
      <nav class="nav">
        <ul class="nav-list">
          <li><a class="nav-link" href="/">–ö–∞—Ç–∞–ª–æ–≥</a></li>
        </ul>
      </nav>
      <div class="header-actions">
        <a class="btn outline" href="<%= mode === 'admin' ? '/admin' : '/cabinet' %>">‚Üê –ù–∞–∑–∞–¥</a>
      </div>
    </div>
  </header>

  <main class="container">
    <section class="section">
      <h2>–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å —Ç–æ–≤–∞—Ä/—É—Å–ª—É–≥—É</h2>
      <form id="editProductForm" class="form-grid" enctype="multipart/form-data" method="POST" action="<%= mode === 'admin' ? (product.type === 'banner' ? `/admin/banners/${product._id}/edit` : (product.type === 'service' ? `/admin/services/${product._id}/edit` : `/admin/products/${product._id}/edit`)) : `/cabinet/product/${product._id}/edit` %>">
        <input type="hidden" name="_csrf" value="<%= typeof csrfToken !== 'undefined' ? csrfToken : '' %>">
        <input type="hidden" id="productId" value="<%= product._id %>">
        
        <!-- –°–µ–ª–µ–∫—Ç–æ—Ä —Ç–∏–ø–∞ –ø—É–±–ª–∏–∫–∞—Ü–∏–∏ -->
        <div class="form-section">
          <label for="type">–¢–∏–ø –ø—É–±–ª–∏–∫–∞—Ü–∏–∏:</label>
          <select id="type" name="type" required aria-label="–¢–∏–ø –ø—É–±–ª–∏–∫–∞—Ü–∏–∏">
            <option value="product" <%= (product.type || 'product') === 'product' ? 'selected' : '' %>>–¢–æ–≤–∞—Ä</option>
            <option value="service" <%= product.type === 'service' ? 'selected' : '' %>>–£—Å–ª—É–≥–∞</option>
          </select>
        </div>
        
        <!-- –û—Å–Ω–æ–≤–Ω—ã–µ –ø–æ–ª—è —Ç–æ–≤–∞—Ä–∞ -->
        <input type="text" name="name" value="<%= product.name %>" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞/—É—Å–ª—É–≥–∏" required aria-label="–ù–∞–∑–≤–∞–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞">
        <textarea name="description" placeholder="–û–ø–∏—Å–∞–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞" rows="4" aria-label="–û–ø–∏—Å–∞–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞"><%= product.description || '' %></textarea>
        <input type="number" name="price" value="<%= product.price %>" placeholder="–¶–µ–Ω–∞" min="0" step="1" required aria-label="–¶–µ–Ω–∞">
        <input type="url" name="link" value="<%= product.link || '' %>" placeholder="–°—Å—ã–ª–∫–∞ –Ω–∞ —Ç–æ–≤–∞—Ä" aria-label="–°—Å—ã–ª–∫–∞ –Ω–∞ —Ç–æ–≤–∞—Ä">
        <input type="url" name="video_url" value="<%= product.video_url || '' %>" placeholder="–°—Å—ã–ª–∫–∞ –Ω–∞ –≤–∏–¥–µ–æ (YouTube, –í–ö–æ–Ω—Ç–∞–∫—Ç–µ, Instagram)" aria-label="–°—Å—ã–ª–∫–∞ –Ω–∞ –≤–∏–¥–µ–æ">
        
        <!-- –ü–æ–ª—è –∫–æ–Ω—Ç–∞–∫—Ç–æ–≤ –ø—Ä–æ–¥–∞–≤—Ü–∞ -->
        <div class="form-section">
          <h3>–ö–æ–Ω—Ç–∞–∫—Ç—ã –ø—Ä–æ–¥–∞–≤—Ü–∞</h3>
          <input type="tel" name="phone" value="<%= (product.contacts && product.contacts.phone) || '' %>" placeholder="–¢–µ–ª–µ—Ñ–æ–Ω" aria-label="–¢–µ–ª–µ—Ñ–æ–Ω">
          <input type="email" name="email" value="<%= (product.contacts && product.contacts.email) || '' %>" placeholder="Email" aria-label="Email">
          <input type="text" name="telegram" value="<%= (product.contacts && product.contacts.telegram) || '' %>" placeholder="Telegram (–Ω–∞–ø—Ä–∏–º–µ—Ä: @username)" aria-label="Telegram">
          <input type="text" name="whatsapp" value="<%= (product.contacts && product.contacts.whatsapp) || '' %>" placeholder="WhatsApp (–Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞)" aria-label="WhatsApp">
          <textarea name="contact_method" placeholder="–°–ø–æ—Å–æ–± —Å–≤—è–∑–∏ (–Ω–∞–ø—Ä–∏–º–µ—Ä: –ó–≤–æ–Ω–∏—Ç–µ —Å 9:00 –¥–æ 18:00)" rows="2" aria-label="–°–ø–æ—Å–æ–± —Å–≤—è–∑–∏"><%= (product.contacts && product.contacts.contact_method) || '' %></textarea>
        </div>

        <!-- –¢–µ–∫—É—â–∏–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è -->
        <% 
          const currentImages = product.images && Array.isArray(product.images) && product.images.length > 0 
            ? product.images 
            : (product.image_url ? [product.image_url] : []);
        %>
        <% if (currentImages.length > 0) { %>
          <div class="form-section">
            <h3>–¢–µ–∫—É—â–∏–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è:</h3>
            <div class="current-images-container" style="display:grid;grid-template-columns:repeat(auto-fill, minmax(100px, 1fr));gap:10px;margin-bottom:10px;" role="group" aria-label="–¢–µ–∫—É—â–∏–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è">
              <% currentImages.forEach((img, idx) => { %>
                <div class="current-image-item image-wrapper" data-image-index="<%= idx %>" style="position:relative;aspect-ratio:1;overflow:hidden;border-radius:8px;border:2px solid #ddd;">
                  <img src="<%= img %>" alt="–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ <%= idx + 1 %>" data-original-url="<%= img %>" style="width:100%;height:100%;object-fit:cover;">
                  <button type="button" class="remove-image-btn image-delete-button" data-image-index="<%= idx %>" aria-label="–£–¥–∞–ª–∏—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ <%= idx + 1 %>" style="position:absolute;top:5px;right:5px;background:#f44336;color:#fff;border:none;border-radius:50%;width:24px;height:24px;cursor:pointer;font-size:18px;line-height:1;">√ó</button>
                </div>
              <% }) %>
            </div>
            <input type="hidden" name="current_images" id="currentImagesInput" value="<%= JSON.stringify(currentImages) %>">
          </div>
        <% } %>

        <!-- –ó–∞–≥—Ä—É–∑–∫–∞ –Ω–æ–≤—ã—Ö –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π -->
        <div class="form-section">
          <label for="images">–î–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤—ã–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è (–¥–æ 5 —à—Ç—É–∫ –≤—Å–µ–≥–æ):</label>
          <input 
            type="file" 
            id="images" 
            name="images" 
            accept="image/png,image/jpeg,image/jpg,image/webp" 
            multiple
            data-max-files="5"
            aria-label="–í—ã–±—Ä–∞—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏"
          >
          <small class="form-hint">–ú–æ–∂–Ω–æ –∑–∞–≥—Ä—É–∑–∏—Ç—å –¥–æ 5 –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π –≤—Å–µ–≥–æ. –§–æ—Ä–º–∞—Ç—ã: PNG, JPEG, JPG, WEBP. –ú–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π —Ä–∞–∑–º–µ—Ä: 5MB –Ω–∞ —Ñ–∞–π–ª.</small>
          <div id="imagePreview" class="image-preview-container" style="display:grid;grid-template-columns:repeat(auto-fill, minmax(100px, 1fr));gap:10px;margin-top:10px;" role="group" aria-label="–ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä –Ω–æ–≤—ã—Ö –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π"></div>
        </div>

        <select name="category" required aria-label="–ö–∞—Ç–µ–≥–æ—Ä–∏—è —Ç–æ–≤–∞—Ä–∞">
          <option value="home" <%= product.category === 'home' ? 'selected' : '' %>>–î–ª—è –¥–æ–º–∞</option>
          <option value="beauty" <%= product.category === 'beauty' ? 'selected' : '' %>>–ö—Ä–∞—Å–æ—Ç–∞ –∏ –∑–¥–æ—Ä–æ–≤—å–µ</option>
          <option value="auto" <%= product.category === 'auto' ? 'selected' : '' %>>–ê–≤—Ç–æ –º–æ—Ç–æ</option>
          <option value="electric" <%= product.category === 'electric' ? 'selected' : '' %>>–≠–ª–µ–∫—Ç—Ä–∏–∫–∞</option>
          <option value="electronics" <%= product.category === 'electronics' ? 'selected' : '' %>>–≠–ª–µ–∫—Ç—Ä–æ–Ω–∏–∫–∞</option>
          <option value="plumbing" <%= product.category === 'plumbing' ? 'selected' : '' %>>–°–∞–Ω—Ç–µ—Ö–Ω–∏–∫–∞</option>
        </select>

        <button type="submit" class="btn primary" aria-label="–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è</button>
      </form>
      <div id="editProductMsg" class="note" style="margin-top:10px;" role="status" aria-live="polite"></div>
    </section>
  </main>

  <footer class="footer">
    <p>¬© 2025 EXTO Ecosystem</p>
  </footer>

  <script src="/js/edit-form.js"></script>
  <script>
    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Ñ–æ—Ä–º—ã —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –ø–æ—Å–ª–µ –∑–∞–≥—Ä—É–∑–∫–∏ DOM
    (function() {
      function initializeForm() {
        if (typeof initEditForm === 'function') {
          console.log('üöÄ –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Ñ–æ—Ä–º—ã —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è', {
            productId: '<%= product._id %>',
            mode: '<%= mode || "user" %>',
            imagesCount: <%= currentImages.length %>
          });
          
          initEditForm({
            mode: '<%= mode || "user" %>',
            productId: '<%= product._id %>',
            currentImages: <%= JSON.stringify(currentImages) %>
          });
        } else {
          console.error('‚ùå –§—É–Ω–∫—Ü–∏—è initEditForm –Ω–µ –Ω–∞–π–¥–µ–Ω–∞');
        }
      }
      
      // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º —Å—Ä–∞–∑—É, –µ—Å–ª–∏ DOM —É–∂–µ –∑–∞–≥—Ä—É–∂–µ–Ω, –∏–ª–∏ –∂–¥–µ–º –∑–∞–≥—Ä—É–∑–∫–∏
      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', initializeForm);
      } else {
        // DOM —É–∂–µ –∑–∞–≥—Ä—É–∂–µ–Ω
        setTimeout(initializeForm, 0);
      }
    })();
  </script>
</body>
</html>
