<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>Личный кабинет</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes">
  <meta name="csrf-token" content="<%= typeof csrfToken !== 'undefined' ? csrfToken : '' %>">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="/styles.css?v=1.0.1">
  <style>
    .tabs {
      display: flex;
      gap: 10px;
      margin-bottom: 20px;
      border-bottom: 2px solid #ddd;
    }
    .tab {
      padding: 12px 24px;
      background: transparent;
      border: none;
      border-bottom: 3px solid transparent;
      cursor: pointer;
      font-size: 1rem;
      font-weight: 500;
      color: #666;
      transition: all 0.2s;
    }
    .tab:hover {
      color: #2196f3;
    }
    .tab.active {
      color: #2196f3;
      border-bottom-color: #2196f3;
    }
    .tab-content {
      display: none;
    }
    .tab-content.active {
      display: block;
    }
    .empty-state {
      text-align: center;
      padding: 40px 20px;
      color: #666;
    }

    /* Стили для нового footer в кабинете */
    .cabinet-footer {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      background: linear-gradient(to bottom, transparent, rgba(30, 46, 0.8));
      border-top: 1px solid rgba(255,0,0,0.25);
      box-shadow: 0 -2px 10px rgba(0,0,0,0.3);
      z-index: 1000;
      padding: 12px 0;
    }

    .footer-buttons {
      display: flex;
      gap: 12px;
      padding: 0 16px;
      max-width: 1200px;
      margin: 0 auto;
    }

    .footer-btn {
      flex: 1;
      padding: 14px 8px;
      border: none;
      background: transparent;
      color: #fff;
      cursor: pointer;
      font-size: 1rem;
      font-weight: 600;
      transition: all 0.2s ease;
      position: relative;
      text-align: center;
      border-radius: 10px;
      border: 2px solid transparent;
      box-shadow: 0 0 10px rgba(255, 0, 0, 0.35), 0 0 22px rgba(255, 0, 0, 0.2);
      background:
        linear-gradient(#2e0b0b, #2e0b0b) padding-box,
        linear-gradient(45deg, var(--color-accent-strong), #ff4d4d) border-box;
    }

    .footer-btn:hover {
      color: #fff;
      background: rgba(255, 51, 51, 0.1);
      transform: translateY(-1px);
      box-shadow: 0 0 14px rgba(255, 0, 0, 0.55), 0 0 28px rgba(255, 0, 0, 0.28);
    }

    .footer-btn:active {
      transform: translateY(0);
    }

    /* Стили для модальных окон в кабинете */
    .modal {
      display: none;
      position: fixed;
      z-index: 2000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.8);
      overflow-y: auto;
    }

    .modal-content {
      background: #111;
      margin: 2% auto;
      padding: 20px;
      border-radius: 10px;
      width: 95%;
      max-width: 900px;
      box-shadow: 0 0 20px #ff3333;
      position: relative;
      box-sizing: border-box;
    }

    .modal .close {
      color: #fff;
      font-size: 28px;
      cursor: pointer;
      background: transparent;
      border: none;
      position: absolute;
      top: 10px;
      right: 14px;
      z-index: 10;
    }

    .modal .close:hover {
      color: #ff3333;
    }

    /* Адаптивность для мобильных устройств */
    @media (max-width: 768px) {
      .modal-content {
        width: 98%;
        margin: 1% auto;
        padding: 15px;
        max-width: 100%;
      }

      .footer-btn {
        padding: 12px 6px;
        font-size: 0.9rem;
      }
    }

    @media (max-width: 480px) {
      .modal-content {
        width: 99%;
        margin: 0.5% auto;
        padding: 12px;
        border-radius: 8px;
      }

      .footer-btn {
        padding: 10px 4px;
        font-size: 0.8rem;
      }
    }

    /* Улучшенная адаптивность для очень маленьких экранов */
    @media (max-width: 360px) {
      .modal-content {
        width: 100%;
        margin: 0;
        padding: 10px;
        border-radius: 6px;
      }

      .modal .close {
        font-size: 24px;
        top: 8px;
        right: 10px;
      }
    }
  </style>
</head>
<body>
  <header class="main-header">
    <div class="container header-inner">
      <a class="logo" href="/"><img src="/albamount.png" alt="ALBAMOUNT" class="logo-img"></a>
      <nav class="nav" style="display:none;">
        <!-- Навигация скрыта -->
      </nav>
      <div class="header-actions">
        <span class="user-chip">👤 <%= user.username %></span>
        <form id="logoutForm" method="POST" action="/logout" style="display:inline;margin-left:10px;">
          <button type="submit" class="btn outline small">Выход</button>
        </form>
      </div>
    </div>
  </header>

  <main class="container">
    <section class="section">
      <h1>Личный кабинет</h1>
      
      <!-- Вкладки -->
      <div class="tabs">
        <button class="tab active" data-tab="products">Мои товары</button>
        <button class="tab" data-tab="services">Мои услуги</button>
        <button class="tab" data-tab="banners">Мои баннеры</button>
        <button class="tab" data-tab="create">Создать карточку</button>
      </div>

      <!-- Вкладка: Мои товары -->
      <div class="tab-content active" id="tab-products">
        <h2>Мои товары</h2>
        <% if (products && products.length > 0) { %>
          <div class="product-grid">
            <% products.forEach(product => { %>
              <%- include('partials/card', { product, itemType: 'product', mode: 'user', user }) %>
            <% }) %>
          </div>
        <% } else { %>
          <div class="empty-state">
            <p>У вас пока нет товаров.</p>
            <button class="tab btn primary" data-tab="create" style="margin-top: 20px;">Создать товар</button>
          </div>
        <% } %>
      </div>

      <!-- Вкладка: Мои услуги -->
      <div class="tab-content" id="tab-services">
        <h2>Мои услуги</h2>
        <% if (services && services.length > 0) { %>
          <div class="product-grid">
            <% services.forEach(service => { %>
              <%- include('partials/card', { service, itemType: 'service', mode: 'user', user }) %>
            <% }) %>
          </div>
        <% } else { %>
          <div class="empty-state">
            <p>У вас пока нет услуг.</p>
            <button class="tab btn primary" data-tab="create" style="margin-top: 20px;">Создать услугу</button>
          </div>
        <% } %>
      </div>

      <!-- Вкладка: Мои баннеры -->
      <div class="tab-content" id="tab-banners">
        <h2>Мои баннеры</h2>
        <% if (banners && banners.length > 0) { %>
          <div class="product-grid">
            <% banners.forEach(banner => { %>
              <%- include('partials/card', { banner, itemType: 'banner', mode: 'user', user }) %>
            <% }) %>
          </div>
        <% } else { %>
          <div class="empty-state">
            <p>У вас пока нет баннеров.</p>
            <button class="tab btn primary" data-tab="create" style="margin-top: 20px;">Создать баннер</button>
          </div>
        <% } %>
      </div>

      <!-- Вкладка: ALBA баланс -->
      <div class="tab-content" id="tab-alba">
        <h2>ALBA баланс</h2>
        <div style="background: #f5f5f5; padding: 20px; border-radius: 12px; margin-bottom: 20px;">
          <h3 style="color: #ff3333; margin-bottom: 10px;">💰 Ваш ALBA баланс</h3>
          <% if (typeof user.albaBalance !== 'undefined') { %>
            <div id="albaBalanceDisplay" style="font-size: 2rem; font-weight: bold; color: #ff3333; margin-bottom: 10px;">
              <%= user.albaBalance %> ALBA
            </div>
          <% } else { %>
            <div id="albaBalanceDisplay" style="font-size: 1.5rem; color: #666; margin-bottom: 10px;">
              Загрузка баланса...
            </div>
          <% } %>
          <p style="color: #666; margin-bottom: 15px;">
            ALBA - это внутренняя валюта платформы Albamount. Используйте её для специальных возможностей и бонусов.
        </p>
        </div>
      
        <!-- История транзакций -->
        <div>
          <h3 style="margin-bottom: 15px;">История транзакций</h3>
          <button id="refreshAlbaBtn" class="btn small" style="margin-bottom: 15px;">🔄 Обновить данные</button>
          <div id="albaTransactionsContainer">
            <% if (typeof albaTransactions !== 'undefined' && albaTransactions.length > 0) { %>
              <div style="max-height: 400px; overflow-y: auto; border: 1px solid #ddd; border-radius: 8px; padding: 15px;">
                <% albaTransactions.forEach(function(tx) { %>
                  <div class="alba-tx-item" style="padding: 12px; border-bottom: 1px solid #eee; margin-bottom: 8px; border-radius: 4px;"
                       data-amount="<%= tx.amount %>">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                      <div>
                        <strong class="alba-amount" data-amount="<%= tx.amount %>"><%= tx.amount > 0 ? '+' : '' %><%= tx.amount %> ALBA</strong>
                        <div style="font-size: 0.9rem; color: #666; margin-top: 4px;">
                          <%= tx.reason %> <%= tx.type === 'referral_bonus' ? '(реферальный бонус)' : '' %>
                        </div>
                        <div style="font-size: 0.8rem; color: #999; margin-top: 4px;">
                          <%= new Date(tx.createdAt).toLocaleString() %>
                        </div>
                      </div>
                    </div>
                  </div>
                <% }); %>
              </div>
            <% } else { %>
              <div style="text-align: center; padding: 40px 20px; color: #666;">
                <p>У вас пока нет транзакций ALBA.</p>
                <p style="font-size: 0.9rem; margin-top: 10px; color: #999;">
                  ALBA можно получить за активность на платформе, реферальные бонусы и специальные акции.
                </p>
              </div>
            <% } %>
          </div>
        </div>
      </div>

      <!-- Вкладка: Создать карточку -->
      <div class="tab-content" id="tab-create">
        <h2>Создать карточку</h2>
        
        <!-- Форма создания товара/услуги -->
        <div id="createProductSection">
          <h3>Товар или услуга</h3>
          <form id="createProductForm" class="form-grid" enctype="multipart/form-data" method="POST" action="/cabinet/product">
            <div class="form-section">
              <label for="type">Тип публикации:</label>
              <select id="type" name="type" required>
                <option value="product">Товар</option>
                <option value="service">Услуга</option>
              </select>
            </div>
            
            <input type="text" name="name" placeholder="Название" required>
            <textarea name="description" placeholder="Описание" rows="4"></textarea>
            <input type="url" name="link" placeholder="Ссылка">
            <input type="url" name="video_url" placeholder="Ссылка на видео (YouTube, ВКонтакте, Instagram)">
            <input type="number" name="price" placeholder="Цена" min="0" step="1" required>
            
            <div class="form-section">
              <label for="images">Изображения (до 5 шт.):</label>
              <input type="file" id="images" name="images" accept="image/*" multiple data-max-files="5">
              <div id="imagePreview" class="image-preview-container" style="display: none; margin-top: 10px; display: grid; grid-template-columns: repeat(auto-fill, minmax(100px, 1fr)); gap: 10px;"></div>
              <small class="form-hint">Можно выбрать до 5 изображений</small>
            </div>
            
                        <div class="form-section">
              <label>&#1050;&#1072;&#1090;&#1077;&#1075;&#1086;&#1088;&#1080;&#1103;:</label>
              <div id="categorySelectorContainer">
                <select name="category" id="categorySelect" required>
              <option value="home">Для дома</option>
              <option value="beauty">Красота и здоровье</option>
              <option value="auto">Авто мото</option>
              <option value="electric">Электрика</option>
              <option value="electronics">Электроника</option>
              <option value="plumbing">Сантехника</option>
                            </select>
                <div id="subcategorySelector" style="margin-top: 10px; display: none;">
                  <button class="btn small outline" id="backToBlocks" style="margin-bottom: 10px;">&larr; &#1053;&#1072;&#1079;&#1072;&#1076; &#1082; &#1073;&#1083;&#1086;&#1082;&#1072;&#1084;</button>
                  <select id="subcategorySelect" style="width: 100%;">
                    <option value="">&#1042;&#1099;&#1073;&#1077;&#1088;&#1080;&#1090;&#1077; &#1087;&#1086;&#1076;&#1082;&#1072;&#1090;&#1077;&#1075;&#1086;&#1088;&#1080;&#1102;</option>
                  </select>
                </div>
              </div>
            
            <div class="form-section">
              <h3 style="margin-bottom: 10px;">Контакты продавца</h3>
              <input type="tel" name="phone" placeholder="Телефон">
              <input type="email" name="email" placeholder="Email">
              <input type="text" name="telegram" placeholder="Telegram (например: @username)">
              <input type="text" name="whatsapp" placeholder="WhatsApp (номер телефона)">
              <label for="contact_method">Способ связи:</label>
              <textarea id="contact_method" name="contact_method" placeholder="Укажите предпочтительный способ связи (например: Звоните с 9:00 до 18:00, Пишите в Telegram)" rows="2"></textarea>
            </div>
            
            <button type="submit" class="btn primary">Отправить на модерацию</button>
          </form>
          <div id="createProductMsg" class="note" style="margin-top:10px;"></div>
        </div>

        <!-- Форма создания баннера -->
        <div id="createBannerSection" style="margin-top: 40px;">
          <h3>Баннер рекламы</h3>
          <p style="margin-bottom: 15px; color: #666;">Загрузите баннер для секции "Тут ваша реклама" на главной странице. Баннер будет отправлен на модерацию.</p>
          <form id="createBannerForm" class="form-grid" enctype="multipart/form-data" method="POST" action="/cabinet/banner">
            <input type="hidden" name="_csrf" value="<%= typeof csrfToken !== 'undefined' ? csrfToken : '' %>">
            <div class="form-section">
              <label for="bannerImage">Изображение баннера:</label>
              <input type="file" id="bannerImage" name="image" accept="image/*" required>
              <div id="bannerPreview" class="image-preview-container" style="display: none; margin-top: 10px;">
                <img id="bannerPreviewImg" src="" alt="Предпросмотр баннера" style="max-width: 100%; max-height: 300px; border-radius: 8px;">
              </div>
              <small class="form-hint">Максимальный размер файла: 5MB. Рекомендуемые размеры: 1200x400px</small>
            </div>
            <input type="url" name="link" placeholder="Ссылка для перехода (необязательно)">
            <button type="submit" class="btn primary">Отправить на модерацию</button>
          </form>
          <div id="createBannerMsg" class="note" style="margin-top:10px;"></div>
        </div>
      </div>
    </section>
  </main>



  
  
  
  
    
  
    
    

  <!-- Модальное окно для баланса ALBA -->
  <div id="albaBalanceModal" class="modal">
    <div class="modal-content">
      <span class="close" id="closeAlbaModal">&times;</span>
      <h2 style="color: #ff3333; margin-bottom: 20px;">Ваш ALBA баланс</h2>
      <% if (typeof user.albaBalance !== 'undefined') { %>
        <div id="modalAlbaBalance" style="font-size: 2.5rem; font-weight: bold; color: #ff3333; margin-bottom: 20px; text-align: center;">
          <%= user.albaBalance %> ALBA
        </div>
      <% } else { %>
        <div id="modalAlbaBalance" style="font-size: 1.8rem; color: #ccc; margin-bottom: 20px; text-align: center;">
          Загрузка баланса...
        </div>
      <% } %>

      <div style="margin-bottom: 20px; padding: 15px; background: rgba(255, 51, 51, 0.05); border-radius: 10px; border: 1px solid rgba(255, 51, 51, 0.2);">
        <h3 style="color: #ff9999; margin-bottom: 10px; font-size: 1.1rem;">Покупка дополнительных карточек</h3>
        <p style="color: #ccc; margin-bottom: 15px; font-size: 0.95rem; line-height: 1.5;">
          Используйте ALBA для покупки права на создание дополнительных карточек товаров, услуг или баннеров.
        </p>

        <div style="margin-bottom: 15px;">
          <label style="display: block; color: #ff9999; margin-bottom: 8px; font-weight: 600;">Тип карточки:</label>
          <select id="cardType" style="width: 100%; padding: 12px; background: #2a2a2a; border: 1px solid rgba(255, 51, 51, 0.3); border-radius: 8px; color: #fff;">
            <option value="product" data-cost="30">Товар (30 ALBA)</option>
            <option value="service" data-cost="30">Услуга (30 ALBA)</option>
            <option value="banner" data-cost="50">Баннер (50 ALBA)</option>
          </select>
        </div>

        <div style="margin-bottom: 15px;">
          <label style="display: block; color: #ff9999; margin-bottom: 8px; font-weight: 600;">Количество:</label>
          <input type="number" id="cardsToBuy" min="1" max="10" value="1"
                 style="width: 100%; padding: 12px; background: #2a2a2a; border: 1px solid rgba(255, 51, 51, 0.3); border-radius: 8px; color: #fff; text-align: center;">
        </div>

        <div style="margin-bottom: 15px; padding: 12px; background: rgba(255, 51, 51, 0.1); border-radius: 8px; border: 1px solid rgba(255, 51, 51, 0.2);">
          <strong style="color: #ff9999;">Общая стоимость:</strong>
          <span id="totalCostDisplay" style="color: #fff; font-weight: bold; margin-left: 10px;">30 ALBA</span>
        </div>

        <button id="buyEntitlementBtn" class="btn primary" style="width: 100%; padding: 14px;">Купить право на карточку</button>
        <div id="purchaseStatus" style="text-align: center; font-size: 0.9rem; color: #ff9999; min-height: 24px; margin-top: 10px;"></div>
      </div>

      <p style="color: #ccc; margin-bottom: 20px; text-align: center; line-height: 1.6;">
        ALBA - это внутренняя валюта платформы Albamount. Используйте её для специальных возможностей и бонусов.
      </p>

      <!-- Available entitlements info -->
      <div id="entitlementsInfo" style="margin-bottom: 20px;"></div>

      <div style="text-align: center; margin-top: 20px;">
        <button id="refreshAlbaModalBtn" class="btn primary" style="margin-right: 10px;">Обновить баланс</button>
        <button id="closeAlbaModalBtn" class="btn outline">Закрыть</button>
      </div>
    </div>
  </div>

  <!-- Модальное окно для реферальной программы -->
  <div id="referralModal" class="modal">
    <div class="modal-content">
      <span class="close" id="closeReferralModal">&times;</span>
      <h2 style="color: #ff3333; margin-bottom: 20px;">Реферальная программа</h2>
      <p style="color: #ccc; margin-bottom: 20px; line-height: 1.6;">
        Приглашайте друзей и получайте бонусы! За каждого приглашенного друга вы получаете 100 ALBA.
      </p>

      <div style="margin-bottom: 20px;">
        <label style="display: block; color: #ff9999; margin-bottom: 8px; font-weight: 600;">Ваша реферальная ссылка:</label>
        <div style="display: flex; gap: 10px;">
          <input type="text" id="referralLink" value="<%= 'https://albamount.com/register?ref=' + (user.referralCode || '') %>" readonly
                 style="flex: 1; padding: 12px; background: #2a2a2a; border: 1px solid rgba(255, 51, 51, 0.3); border-radius: 8px; color: #fff;">
          <button id="copyReferralLink" class="btn primary" style="white-space: nowrap;">Копировать</button>
        </div>
      </div>

      <div style="margin-bottom: 20px;">
        <label style="display: block; color: #ff9999; margin-bottom: 8px; font-weight: 600;">Ваш реферальный код:</label>
        <div style="display: flex; gap: 10px;">
          <input type="text" id="referralCode" value="<%= user.referralCode || '' %>" readonly
                 style="flex: 1; padding: 12px; background: #2a2a2a; border: 1px solid rgba(255, 51, 51, 0.3); border-radius: 8px; color: #fff;">
          <button id="copyReferralCode" class="btn primary" style="white-space: nowrap;">Копировать</button>
        </div>
      </div>

      <div style="text-align: center;">
        <button id="closeReferralModalBtn" class="btn outline">Закрыть</button>
      </div>
    </div>
  </div>

  <!-- Новый footer с кнопками -->
  <footer class="cabinet-footer">
    <div class="footer-buttons">
      <% if (typeof user.albaBalance !== 'undefined') { %>
        <button id="albaBalanceBtn" class="footer-btn">
          Баланс: <span id="footerAlbaBalance"><%= user.albaBalance %></span> ALBA
        </button>
      <% } else { %>
        <button id="albaBalanceBtn" class="footer-btn">
          Баланс: <span id="footerAlbaBalance">Загрузка...</span>
        </button>
      <% } %>
      <button id="referralBtn" class="footer-btn">Пригласить</button>
    </div>
  </footer>

  <!-- Загрузка YouTube IFrame API -->
    <!-- Bootstrap script for safe EJS to JS data transfer -->
  <script src="/utils/bootstrap.js"></script>
  <script>
    window.AppBootstrap.init(<%- JSON.stringify({
      isAuth: true,
      isAdmin: typeof isAdmin !== 'undefined' ? isAdmin : false,
      socketIoAvailable: typeof socket_io_available !== 'undefined' ? socket_io_available : false,
      userRole: typeof userRole !== 'undefined' ? userRole : null,
      csrfToken: typeof csrfToken !== 'undefined' ? csrfToken : ''
    }) %>);
  </script>

  <script src="/js/cabinet.js?v=1.0.1"></script>

<script>
    var tag = document.createElement('script');
    tag.src = "https://www.youtube.com/iframe_api";
    var firstScriptTag = document.getElementsByTagName('script')[0];
    firstScriptTag.parentNode.insertBefore(tag, firstScriptTag);
  </script>

  <script>
    // Function to refresh ALBA data
    async function refreshAlbaData() {
      try {
        const response = await fetch('/api/p1/alba/transactions');
        const data = await response.json();

        if (data.success) {
          // Update the ALBA balance display
          const balanceElement = document.getElementById('albaBalanceDisplay');
          if (balanceElement) {
            // Use current user data from the page instead of API
            const currentBalance = document.getElementById('footerAlbaBalance')?.textContent || '0';
            if (currentBalance && currentBalance !== 'Загрузка...') {
              balanceElement.textContent = currentBalance + ' ALBA';
              balanceElement.style.fontSize = '2rem';
              balanceElement.style.fontWeight = 'bold';
              balanceElement.style.color = '#ff3333';
            }
          }

          // Update the transactions container
          const container = document.getElementById('albaTransactionsContainer');
          if (container) {
            let html = '<div style="max-height: 400px; overflow-y: auto; border: 1px solid #ddd; border-radius: 8px; padding: 15px;">';

            if (data.transactions && data.transactions.length > 0) {
              data.transactions.forEach(tx => {
                const backgroundColor = tx.amount > 0 ? '#e8f5e9' : '#ffebee';
                const textColor = tx.amount > 0 ? '#2e7d32' : '#c62828';

                html += `
                  <div style="padding: 12px; border-bottom: 1px solid #eee; background: ${backgroundColor}; margin-bottom: 8px; border-radius: 4px;">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                      <div>
                        <strong style="color: ${textColor};">${tx.amount > 0 ? '+' : ''}${tx.amount} ALBA</strong>
                        <div style="font-size: 0.9rem; color: #666; margin-top: 4px;">
                          ${tx.reason} ${tx.type === 'referral_bonus' ? '(реферальный бонус)' : ''}
                        </div>
                        <div style="font-size: 0.8rem; color: #999; margin-top: 4px;">
                          ${new Date(tx.createdAt).toLocaleString()}
                        </div>
                      </div>
                    </div>
                  </div>
                `;
              });
            } else {
              html += `
                <div style="text-align: center; padding: 40px 20px; color: #666;">
                  <p>У вас пока нет транзакций ALBA.</p>
                  <p style="font-size: 0.9rem; margin-top: 10px; color: #999;">
                    ALBA можно получить за активность на платформе, реферальные бонусы и специальные акции.
                  </p>
                </div>
              `;
            }

            html += '</div>';
            container.innerHTML = html;
          }

        } else {
        }
      } catch (error) {
      }
    }

    // Add event listener to the refresh button
    document.addEventListener('DOMContentLoaded', function() {
      const refreshBtn = document.getElementById('refreshAlbaBtn');
      if (refreshBtn) {
        refreshBtn.addEventListener('click', refreshAlbaData);
      }

      // Apply styling to ALBA transaction items
      const txItems = document.querySelectorAll('.alba-tx-item');
      txItems.forEach(item => {
        const amount = parseFloat(item.getAttribute('data-amount'));
        if (amount > 0) {
          item.style.background = '#e8f5e9';
        } else {
          item.style.background = '#ffebee';
        }
      });

      // Apply styling to ALBA amount elements
      const amountElements = document.querySelectorAll('.alba-amount');
      amountElements.forEach(element => {
        const amount = parseFloat(element.getAttribute('data-amount'));
        if (amount > 0) {
          element.style.color = '#2e7d32';
        } else {
          element.style.color = '#c62828';
        }
      });

      // Модальное окно баланса ALBA
      const albaBalanceBtn = document.getElementById('albaBalanceBtn');
      const albaBalanceModal = document.getElementById('albaBalanceModal');
      const closeAlbaModal = document.getElementById('closeAlbaModal');
      const closeAlbaModalBtn = document.getElementById('closeAlbaModalBtn');
      const refreshAlbaModalBtn = document.getElementById('refreshAlbaModalBtn');
      const buyCardsBtn = document.getElementById('buyCardsBtn');
      const cardsToBuyInput = document.getElementById('cardsToBuy');
      const purchaseStatus = document.getElementById('purchaseStatus');

      if (albaBalanceBtn && albaBalanceModal) {
        albaBalanceBtn.addEventListener('click', () => {
          albaBalanceModal.style.display = 'block';
        });
      }

      if (closeAlbaModal) {
        closeAlbaModal.addEventListener('click', () => {
          albaBalanceModal.style.display = 'none';
        });
      }

      if (closeAlbaModalBtn) {
        closeAlbaModalBtn.addEventListener('click', () => {
          albaBalanceModal.style.display = 'none';
        });
      }

      if (refreshAlbaModalBtn) {
        refreshAlbaModalBtn.addEventListener('click', async () => {
          try {
            // Use current user data from the page instead of API
            const currentBalance = document.getElementById('footerAlbaBalance')?.textContent || '0';
            if (currentBalance && currentBalance !== 'Загрузка...') {
              const modalBalanceElement = document.getElementById('modalAlbaBalance');
              const footerBalanceElement = document.getElementById('footerAlbaBalance');

              if (modalBalanceElement) {
                modalBalanceElement.textContent = currentBalance + ' ALBA';
              }

              if (footerBalanceElement) {
                footerBalanceElement.textContent = currentBalance;
              }
            }
          } catch (error) {
          }
        });
      }

      // Обработка покупки дополнительных карточек
      const cardTypeSelect = document.getElementById('cardType');
      const totalCostDisplay = document.getElementById('totalCostDisplay');

      // Функция для обновления общей стоимости
      function updateTotalCost() {
        if (cardTypeSelect && cardsToBuyInput && totalCostDisplay) {
          const cardType = cardTypeSelect.value;
          const cardsToBuy = parseInt(cardsToBuyInput.value) || 1;

          // Получаем стоимость из data-cost или по умолчанию
          const costPerCard = parseInt(cardTypeSelect.selectedOptions[0]?.dataset?.cost) || 30;
          const totalCost = cardsToBuy * costPerCard;

          totalCostDisplay.textContent = `${totalCost} ALBA`;
        }
      }

      // Обновляем стоимость при загрузке и изменении
      if (cardTypeSelect && cardsToBuyInput) {
        cardTypeSelect.addEventListener('change', updateTotalCost);
        cardsToBuyInput.addEventListener('input', updateTotalCost);
        updateTotalCost(); // Инициализация
      }

      if (buyCardsBtn && cardsToBuyInput && purchaseStatus) {
        buyCardsBtn.addEventListener('click', () => {
          const cardType = cardTypeSelect?.value || 'product';
          const cardsToBuy = parseInt(cardsToBuyInput.value) || 1;
          const currentBalanceText = document.getElementById('footerAlbaBalance')?.textContent || '0';
          const currentBalance = currentBalanceText === 'Загрузка...' ? 0 : parseInt(currentBalanceText);

          // Получаем актуальную стоимость
          const costPerCard = parseInt(cardTypeSelect?.selectedOptions[0]?.dataset?.cost) || 30;
          const totalCost = cardsToBuy * costPerCard;

          // Типы карточек для сообщений
          const cardTypeNames = {
            'product': 'товаров',
            'service': 'услуг',
            'banner': 'баннеров'
          };
          const cardTypeName = cardTypeNames[cardType] || 'карточек';

          if (isNaN(currentBalance) || currentBalance <= 0) {
            purchaseStatus.textContent = 'Ошибка: не удалось определить текущий баланс';
            purchaseStatus.style.color = '#ff6666';
            return;
          }

          if (currentBalance < totalCost) {
            purchaseStatus.textContent = `Недостаточно ALBA. Требуется ${totalCost}, у вас ${currentBalance}`;
            purchaseStatus.style.color = '#ff6666';
            return;
          }

          // Симулируем покупку (в реальном проекте здесь будет API запрос)
          const newBalance = currentBalance - totalCost;

          // Обновляем баланс в интерфейсе
          const modalBalanceElement = document.getElementById('modalAlbaBalance');
          const footerBalanceElement = document.getElementById('footerAlbaBalance');

          if (modalBalanceElement) {
            modalBalanceElement.textContent = `${newBalance} ALBA`;
          }

          if (footerBalanceElement) {
            footerBalanceElement.textContent = newBalance.toString();
          }

          purchaseStatus.textContent = `Успешно! Куплено ${cardsToBuy} ${cardTypeName} за ${totalCost} ALBA`;
          purchaseStatus.style.color = '#66ff66';

          // Сбрасываем статус через 5 секунд
          setTimeout(() => {
            purchaseStatus.textContent = '';
          }, 5000);
        });
      }

      // Модальное окно реферальной программы
      const referralBtn = document.getElementById('referralBtn');
      const referralModal = document.getElementById('referralModal');
      const closeReferralModal = document.getElementById('closeReferralModal');
      const closeReferralModalBtn = document.getElementById('closeReferralModalBtn');
      const copyReferralLink = document.getElementById('copyReferralLink');
      const copyReferralCode = document.getElementById('copyReferralCode');

      if (referralBtn && referralModal) {
        referralBtn.addEventListener('click', () => {
          referralModal.style.display = 'block';
        });
      }

      if (closeReferralModal) {
        closeReferralModal.addEventListener('click', () => {
          referralModal.style.display = 'none';
        });
      }

      if (closeReferralModalBtn) {
        closeReferralModalBtn.addEventListener('click', () => {
          referralModal.style.display = 'none';
        });
      }

      if (copyReferralLink) {
        copyReferralLink.addEventListener('click', () => {
          const referralLinkInput = document.getElementById('referralLink');
          if (referralLinkInput) {
            referralLinkInput.select();
            document.execCommand('copy');
            copyReferralLink.textContent = 'Скопировано!';
            setTimeout(() => {
              copyReferralLink.textContent = 'Копировать';
            }, 2000);
          }
        });
      }

      if (copyReferralCode) {
        copyReferralCode.addEventListener('click', () => {
          const referralCodeInput = document.getElementById('referralCode');
          if (referralCodeInput) {
            referralCodeInput.select();
            document.execCommand('copy');
            copyReferralCode.textContent = 'Скопировано!';
            setTimeout(() => {
              copyReferralCode.textContent = 'Копировать';
            }, 2000);
          }
        });
      }

      // Закрытие модальных окон при клике вне их
      window.addEventListener('click', (event) => {
        if (event.target === albaBalanceModal) {
          albaBalanceModal.style.display = 'none';
        }
        if (event.target === referralModal) {
          referralModal.style.display = 'none';
        }
      });
    });
  </script>

<% if (!process.env.VERCEL) { %>
<!-- Socket.IO -->
<script src="/socket.io/socket.io.js"></script>
<% } %>

</body>
</html>
