<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>Личный кабинет</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes">
  <meta name="csrf-token" content="<%= typeof csrfToken !== 'undefined' ? csrfToken : '' %>">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="/styles.css?v=1.0.1">
  <style>
    .tabs {
      display: flex;
      gap: 10px;
      margin-bottom: 20px;
      border-bottom: 2px solid #ddd;
    }
    .tab {
      padding: 12px 24px;
      background: transparent;
      border: none;
      border-bottom: 3px solid transparent;
      cursor: pointer;
      font-size: 1rem;
      font-weight: 500;
      color: #666;
      transition: all 0.2s;
    }
    .tab:hover {
      color: #2196f3;
    }
    .tab.active {
      color: #2196f3;
      border-bottom-color: #2196f3;
    }
    .tab-content {
      display: none;
    }
    .tab-content.active {
      display: block;
    }
    .empty-state {
      text-align: center;
      padding: 40px 20px;
      color: #666;
    }
  </style>
</head>
<body>
  <header class="main-header">
    <div class="container header-inner">
      <a class="logo" href="/"><img src="/albamount.png" alt="ALBAMOUNT" class="logo-img"></a>
      <nav class="nav" style="display:none;">
        <!-- Навигация скрыта -->
      </nav>
      <div class="header-actions">
        <span class="user-chip">👤 <%= user.username %></span>
        <% if (typeof user.albaBalance !== 'undefined') { %>
          <span class="alba-balance" style="margin-left: 10px; background: #ff9999; padding: 4px 12px; border-radius: 12px; font-weight: bold; color: white;">
            💰 <%= user.albaBalance %> ALBA
          </span>
        <% } %>
        <form id="logoutForm" method="POST" action="/logout" style="display:inline;margin-left:10px;">
          <button type="submit" class="btn outline small">Выход</button>
        </form>
      </div>
    </div>
  </header>

  <main class="container">
    <section class="section">
      <h1>Личный кабинет</h1>
      
      <!-- Вкладки -->
      <div class="tabs">
        <button class="tab active" data-tab="products">Мои товары</button>
        <button class="tab" data-tab="services">Мои услуги</button>
        <button class="tab" data-tab="banners">Мои баннеры</button>
        <button class="tab" data-tab="alba">ALBA баланс</button>
        <button class="tab" data-tab="create">Создать карточку</button>
      </div>

      <!-- Вкладка: Мои товары -->
      <div class="tab-content active" id="tab-products">
        <h2>Мои товары</h2>
        <% if (products && products.length > 0) { %>
          <div class="product-grid">
            <% products.forEach(product => { %>
              <%- include('partials/card', { product, itemType: 'product', mode: 'user', user }) %>
            <% }) %>
          </div>
        <% } else { %>
          <div class="empty-state">
            <p>У вас пока нет товаров.</p>
            <button class="tab btn primary" data-tab="create" style="margin-top: 20px;">Создать товар</button>
          </div>
        <% } %>
      </div>

      <!-- Вкладка: Мои услуги -->
      <div class="tab-content" id="tab-services">
        <h2>Мои услуги</h2>
        <% if (services && services.length > 0) { %>
          <div class="product-grid">
            <% services.forEach(service => { %>
              <%- include('partials/card', { service, itemType: 'service', mode: 'user', user }) %>
            <% }) %>
          </div>
        <% } else { %>
          <div class="empty-state">
            <p>У вас пока нет услуг.</p>
            <button class="tab btn primary" data-tab="create" style="margin-top: 20px;">Создать услугу</button>
          </div>
        <% } %>
      </div>

      <!-- Вкладка: Мои баннеры -->
      <div class="tab-content" id="tab-banners">
        <h2>Мои баннеры</h2>
        <% if (banners && banners.length > 0) { %>
          <div class="product-grid">
            <% banners.forEach(banner => { %>
              <%- include('partials/card', { banner, itemType: 'banner', mode: 'user', user }) %>
            <% }) %>
          </div>
        <% } else { %>
          <div class="empty-state">
            <p>У вас пока нет баннеров.</p>
            <button class="tab btn primary" data-tab="create" style="margin-top: 20px;">Создать баннер</button>
          </div>
        <% } %>
      </div>

      <!-- Вкладка: ALBA баланс -->
      <div class="tab-content" id="tab-alba">
        <h2>ALBA баланс</h2>
        <div style="background: #f5f5f5; padding: 20px; border-radius: 12px; margin-bottom: 20px;">
          <h3 style="color: #ff3333; margin-bottom: 10px;">💰 Ваш ALBA баланс</h3>
          <% if (typeof user.albaBalance !== 'undefined') { %>
            <div style="font-size: 2rem; font-weight: bold; color: #ff3333; margin-bottom: 10px;">
              <%= user.albaBalance %> ALBA
            </div>
          <% } else { %>
            <div style="font-size: 1.5rem; color: #666; margin-bottom: 10px;">
              Загрузка баланса...
            </div>
          <% } %>
          <p style="color: #666; margin-bottom: 15px;">
            ALBA - это внутренняя валюта платформы Albamount. Используйте её для специальных возможностей и бонусов.
          </p>
        </div>

        <!-- История транзакций -->
        <div>
          <h3 style="margin-bottom: 15px;">История транзакций</h3>
          <% if (typeof albaTransactions !== 'undefined' && albaTransactions.length > 0) { %>
            <div style="max-height: 400px; overflow-y: auto; border: 1px solid #ddd; border-radius: 8px; padding: 15px;">
              <% albaTransactions.forEach(function(tx) { %>
                <div style="padding: 12px; border-bottom: 1px solid #eee; <%= tx.amount > 0 ? 'background: #e8f5e9;' : 'background: #ffebee;' %> margin-bottom: 8px; border-radius: 4px;">
                  <div style="display: flex; justify-content: space-between; align-items: center;">
                    <div>
                      <strong style="<%= tx.amount > 0 ? 'color: #2e7d32;' : 'color: #c62828;' %>"><%= tx.amount > 0 ? '+' : '' %><%= tx.amount %> ALBA</strong>
                      <div style="font-size: 0.9rem; color: #666; margin-top: 4px;">
                        <%= tx.reason %> <%= tx.type === 'referral_bonus' ? '(реферальный бонус)' : '' %>
                      </div>
                      <div style="font-size: 0.8rem; color: #999; margin-top: 4px;">
                        <%= new Date(tx.createdAt).toLocaleString() %>
                      </div>
                    </div>
                  </div>
                </div>
              <% }); %>
            </div>
          <% } else { %>
            <div style="text-align: center; padding: 40px 20px; color: #666;">
              <p>У вас пока нет транзакций ALBA.</p>
              <p style="font-size: 0.9rem; margin-top: 10px; color: #999;">
                ALBA можно получить за активность на платформе, реферальные бонусы и специальные акции.
              </p>
            </div>
          <% } %>
        </div>
      </div>

      <!-- Вкладка: Создать карточку -->
      <div class="tab-content" id="tab-create">
        <h2>Создать карточку</h2>
        
        <!-- Форма создания товара/услуги -->
        <div id="createProductSection">
          <h3>Товар или услуга</h3>
          <form id="createProductForm" class="form-grid" enctype="multipart/form-data" method="POST" action="/cabinet/product">
            <div class="form-section">
              <label for="type">Тип публикации:</label>
              <select id="type" name="type" required>
                <option value="product">Товар</option>
                <option value="service">Услуга</option>
              </select>
            </div>
            
            <input type="text" name="name" placeholder="Название" required>
            <textarea name="description" placeholder="Описание" rows="4"></textarea>
            <input type="url" name="link" placeholder="Ссылка">
            <input type="url" name="video_url" placeholder="Ссылка на видео (YouTube, ВКонтакте, Instagram)">
            <input type="number" name="price" placeholder="Цена" min="0" step="1" required>
            
            <div class="form-section">
              <label for="images">Изображения (до 5 шт.):</label>
              <input type="file" id="images" name="images" accept="image/*" multiple data-max-files="5">
              <div id="imagePreview" class="image-preview-container" style="display: none; margin-top: 10px; display: grid; grid-template-columns: repeat(auto-fill, minmax(100px, 1fr)); gap: 10px;"></div>
              <small class="form-hint">Можно выбрать до 5 изображений</small>
            </div>
            
                        <div class="form-section">
              <label>&#1050;&#1072;&#1090;&#1077;&#1075;&#1086;&#1088;&#1080;&#1103;:</label>
              <div id="categorySelectorContainer">
                <select name="category" id="categorySelect" required>
              <option value="home">Для дома</option>
              <option value="beauty">Красота и здоровье</option>
              <option value="auto">Авто мото</option>
              <option value="electric">Электрика</option>
              <option value="electronics">Электроника</option>
              <option value="plumbing">Сантехника</option>
                            </select>
                <div id="subcategorySelector" style="margin-top: 10px; display: none;">
                  <button class="btn small outline" id="backToBlocks" style="margin-bottom: 10px;">&larr; &#1053;&#1072;&#1079;&#1072;&#1076; &#1082; &#1073;&#1083;&#1086;&#1082;&#1072;&#1084;</button>
                  <select id="subcategorySelect" style="width: 100%;">
                    <option value="">&#1042;&#1099;&#1073;&#1077;&#1088;&#1080;&#1090;&#1077; &#1087;&#1086;&#1076;&#1082;&#1072;&#1090;&#1077;&#1075;&#1086;&#1088;&#1080;&#1102;</option>
                  </select>
                </div>
              </div>
            
            <div class="form-section">
              <h3 style="margin-bottom: 10px;">Контакты продавца</h3>
              <input type="tel" name="phone" placeholder="Телефон">
              <input type="email" name="email" placeholder="Email">
              <input type="text" name="telegram" placeholder="Telegram (например: @username)">
              <input type="text" name="whatsapp" placeholder="WhatsApp (номер телефона)">
              <label for="contact_method">Способ связи:</label>
              <textarea id="contact_method" name="contact_method" placeholder="Укажите предпочтительный способ связи (например: Звоните с 9:00 до 18:00, Пишите в Telegram)" rows="2"></textarea>
            </div>
            
            <button type="submit" class="btn primary">Отправить на модерацию</button>
          </form>
          <div id="createProductMsg" class="note" style="margin-top:10px;"></div>
        </div>

        <!-- Форма создания баннера -->
        <div id="createBannerSection" style="margin-top: 40px;">
          <h3>Баннер рекламы</h3>
          <p style="margin-bottom: 15px; color: #666;">Загрузите баннер для секции "Тут ваша реклама" на главной странице. Баннер будет отправлен на модерацию.</p>
          <form id="createBannerForm" class="form-grid" enctype="multipart/form-data" method="POST" action="/cabinet/banner">
            <input type="hidden" name="_csrf" value="<%= typeof csrfToken !== 'undefined' ? csrfToken : '' %>">
            <div class="form-section">
              <label for="bannerImage">Изображение баннера:</label>
              <input type="file" id="bannerImage" name="image" accept="image/*" required>
              <div id="bannerPreview" class="image-preview-container" style="display: none; margin-top: 10px;">
                <img id="bannerPreviewImg" src="" alt="Предпросмотр баннера" style="max-width: 100%; max-height: 300px; border-radius: 8px;">
              </div>
              <small class="form-hint">Максимальный размер файла: 5MB. Рекомендуемые размеры: 1200x400px</small>
            </div>
            <input type="url" name="link" placeholder="Ссылка для перехода (необязательно)">
            <button type="submit" class="btn primary">Отправить на модерацию</button>
          </form>
          <div id="createBannerMsg" class="note" style="margin-top:10px;"></div>
        </div>
      </div>
    </section>
  </main>



  
  
  
  
    
  
    
    

  <!-- Загрузка YouTube IFrame API -->
    <!-- Bootstrap script for safe EJS to JS data transfer -->
  <script src="/utils/bootstrap.js"></script>
  <script>
    window.AppBootstrap.init(<%- JSON.stringify({
      isAuth: true,
      isAdmin: typeof isAdmin !== 'undefined' ? isAdmin : false,
      socketIoAvailable: typeof socket_io_available !== 'undefined' ? socket_io_available : false,
      userRole: typeof userRole !== 'undefined' ? userRole : null,
      csrfToken: typeof csrfToken !== 'undefined' ? csrfToken : ''
    }) %>);
  </script>

  <script src="/js/cabinet.js?v=1.0.1"></script>

<script>
    var tag = document.createElement('script');
    tag.src = "https://www.youtube.com/iframe_api";
    var firstScriptTag = document.getElementsByTagName('script')[0];
    firstScriptTag.parentNode.insertBefore(tag, firstScriptTag);
  </script>


<% if (!process.env.VERCEL) { %>
<!-- Socket.IO -->
<script src="/socket.io/socket.io.js"></script>
<% } %>

</body>
</html>
