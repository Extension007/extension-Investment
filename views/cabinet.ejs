<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>Личный кабинет</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes">
  <meta name="csrf-token" content="<%= typeof csrfToken !== 'undefined' ? csrfToken : '' %>">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="/styles.css?v=1.0.1">
  <style>
    .tabs {
      display: flex;
      gap: 10px;
      margin-bottom: 20px;
      border-bottom: 2px solid #ddd;
    }
    .tab {
      padding: 12px 24px;
          const imagesInput = form.querySelector('input[name="images"]');
          if (imagesInput && imagesInput.files.length > 5) {
            msg.textContent = "Максимальное количество изображений: 5";
            msg.style.color = "#b00020";
            return;
          }
          
          if (imagesInput && imagesInput.files.length > 0) {
            for (let i = 0; i < imagesInput.files.length; i++) {
              const file = imagesInput.files[i];
              if (file.size > 5 * 1024 * 1024) {
                msg.textContent = `Файл "${file.name}" превышает 5MB`;
                msg.style.color = "#b00020";
                return;
              }
            }
          }
          
          msg.textContent = "Отправка...";
          msg.style.color = "#666";
          
          const formData = new FormData(form);
          const csrfToken = document.querySelector('meta[name="csrf-token"]')?.getAttribute('content');
          
          try {
            const res = await fetch("/cabinet/product", { 
              method: "POST", 
              body: formData,
              headers: {
                'X-CSRF-Token': csrfToken || ''
              },
              credentials: 'same-origin'
            });
            
            const contentType = res.headers.get("content-type");
            if (!contentType || !contentType.includes("application/json")) {
              const text = await res.text();
              msg.textContent = "Ошибка: " + (text || "Неверный формат ответа");
              msg.style.color = "#b00020";
              return;
            }
            
            const json = await res.json();
            
            if (json.success) {
              msg.textContent = "Карточка отправлена на модерацию.";
              msg.style.color = "green";
              form.reset();
              document.getElementById('imagePreview').style.display = 'none';
              setTimeout(() => location.reload(), 800);
            } else {
              msg.textContent = json.message || "Ошибка при создании карточки";
              msg.style.color = "#b00020";
            }
          } catch (err) {
            console.error("❌ Ошибка при отправке:", err);
            msg.textContent = "Ошибка сети: " + err.message;
            msg.style.color = "#b00020";
          }
        });
      }
      }
    </style>
    <script src="/js/cabinet.js?v=1.0.1"></script>

      // Превью изображений
      const imagesInput = document.getElementById('images');
      const imagePreview = document.getElementById('imagePreview');
      
      if (imagesInput && imagePreview) {
        imagesInput.addEventListener('change', function(e) {
          const files = Array.from(e.target.files);
          const maxFiles = parseInt(imagesInput.getAttribute('data-max-files')) || 5;
          
          if (files.length > maxFiles) {
            alert(`Можно выбрать не более ${maxFiles} изображений`);
            e.target.value = '';
            imagePreview.innerHTML = '';
            imagePreview.style.display = 'none';
            return;
          }
          
          imagePreview.innerHTML = '';
          
          if (files.length === 0) {
            imagePreview.style.display = 'none';
            return;
          }
          
          imagePreview.style.display = 'grid';
          
          files.forEach((file) => {
            if (file.size > 5 * 1024 * 1024) {
              alert(`Файл "${file.name}" слишком большой (максимум 5MB)`);
              return;
            }
            
            const reader = new FileReader();
            reader.onload = function(e) {
              const div = document.createElement('div');
              div.className = 'preview-item';
              div.style.position = 'relative';
              div.style.aspectRatio = '1';
              div.style.overflow = 'hidden';
              div.style.borderRadius = '8px';
              div.style.border = '2px solid #ddd';
              
              const img = document.createElement('img');
              img.src = e.target.result;
              img.style.width = '100%';
              img.style.height = '100%';
              img.style.objectFit = 'cover';
              
              div.appendChild(img);
              imagePreview.appendChild(div);
            };
            reader.readAsDataURL(file);
          });
        });
      }

      // Обработка формы загрузки баннера
      const bannerForm = document.getElementById("createBannerForm");
      const bannerMsg = document.getElementById("createBannerMsg");
      const bannerPreview = document.getElementById("bannerPreview");
      const bannerPreviewImg = document.getElementById("bannerPreviewImg");
      const bannerImageInput = document.getElementById("bannerImage");

      if (bannerForm) {
        if (bannerImageInput && bannerPreviewImg) {
          bannerImageInput.addEventListener("change", function(e) {
            const file = e.target.files[0];
            if (file) {
              if (file.size > 5 * 1024 * 1024) {
                alert(`Файл "${file.name}" слишком большой (максимум 5MB)`);
                e.target.value = '';
                bannerPreview.style.display = 'none';
                return;
              }
              
              const reader = new FileReader();
              reader.onload = function(e) {
                bannerPreviewImg.src = e.target.result;
                bannerPreview.style.display = 'block';
              };
              reader.readAsDataURL(file);
            } else {
              bannerPreview.style.display = 'none';
            }
          });
        }

        bannerForm.addEventListener("submit", async (e) => {
          e.preventDefault();
          
          if (bannerImageInput && bannerImageInput.files.length > 0) {
            const file = bannerImageInput.files[0];
            if (file.size > 5 * 1024 * 1024) {
              bannerMsg.textContent = `Файл "${file.name}" превышает 5MB`;
              bannerMsg.style.color = "#b00020";
              return;
            }
          }
          
          bannerMsg.textContent = "Отправка...";
          bannerMsg.style.color = "#666";
          
          const formData = new FormData(bannerForm);
          const csrfToken = document.querySelector('meta[name="csrf-token"]')?.getAttribute('content');
          
          try {
            const res = await fetch("/cabinet/banner", { 
              method: "POST", 
              body: formData,
              headers: {
                'X-CSRF-Token': csrfToken || ''
              },
              credentials: 'same-origin'
            });
            
            const contentType = res.headers.get("content-type");
            if (!contentType || !contentType.includes("application/json")) {
              const text = await res.text();
              bannerMsg.textContent = "Ошибка: " + (text || "Неверный формат ответа");
              bannerMsg.style.color = "#b00020";
              return;
            }
            
            const json = await res.json();
            
            if (json.success) {
              bannerMsg.textContent = "Баннер отправлен на модерацию.";
              bannerMsg.style.color = "green";
              bannerForm.reset();
              bannerPreview.style.display = 'none';
              setTimeout(() => location.reload(), 800);
            } else {
              bannerMsg.textContent = json.message || "Ошибка при загрузке баннера";
              bannerMsg.style.color = "#b00020";
            }
          } catch (err) {
            console.error("❌ Ошибка при отправке:", err);
            bannerMsg.textContent = "Ошибка сети: " + err.message;
            bannerMsg.style.color = "#b00020";
          }
        });
      }
      

      
      // Инициализация выбора категорий
      const categorySelect = document.getElementById('categorySelect');
      const subcategorySelector = document.getElementById('subcategorySelector');
      const subcategorySelect = document.getElementById('subcategorySelect');
      const backToBlocksBtn = document.getElementById('backToBlocks');
      const typeSelect = document.getElementById('type');

      let currentCategories = [];
      let currentType = 'product'; // По умолчанию товар

      // Загружаем блоки категорий при загрузке страницы
      loadCategoryBlocks();

      // Обработчик изменения типа
      if (typeSelect) {
        typeSelect.addEventListener('change', function() {
          currentType = this.value;
          loadCategoryBlocks();
        });
      }

      async function loadCategoryBlocks() {
        try {
          const response = await fetch(`/api/categories/tree/${currentType}`);
          const data = await response.json();

          if (data.success && data.categories) {
            currentCategories = data.categories;
            renderCategoryBlocks(data.categories);
          } else {
            console.error('Ошибка загрузки блоков категорий:', data.message);
          }
        } catch (error) {
          console.error('Ошибка сети при загрузке блоков:', error);
        }
      }

      function renderCategoryBlocks(blocks) {
        if (!categorySelect) return;

        // Очищаем селект, оставляем только первую опцию
        categorySelect.innerHTML = '<option value="">Выберите категорию</option>';

        blocks.forEach(block => {
          const option = document.createElement('option');
          option.value = block._id;
          option.textContent = `${block.icon || ''} ${block.name}`;
          categorySelect.appendChild(option);
        });
      }

      async function loadSubcategories(blockId, blockName) {
        try {
          const response = await fetch(`/api/categories/children/${blockId}`);
          const data = await response.json();

          if (data.success && data.categories) {
            renderSubcategories(data.categories, blockName);
          } else {
            console.error('Ошибка загрузки подкатегорий:', data.message);
          }
        } catch (error) {
          console.error('Ошибка сети при загрузке подкатегорий:', error);
        }
      }

      function renderSubcategories(subcategories, blockName) {
        if (!subcategorySelector || !subcategorySelect) return;

        subcategorySelect.innerHTML = '<option value="">Выберите подкатегорию</option>';

        subcategories.forEach(sub => {
          const option = document.createElement('option');
          option.value = sub._id;
          option.textContent = `${sub.icon || ''} ${sub.name}`;
          subcategorySelect.appendChild(option);
        });

        // Показываем контейнер подкатегорий
        subcategorySelector.style.display = 'block';
      }

      function hideSubcategories() {
        if (subcategorySelector) {
          subcategorySelector.style.display = 'none';
        }
      }

      // Обработчик выбора блока
      if (categorySelect) {
        categorySelect.addEventListener('change', function() {
          const selectedBlockId = this.value;
          if (selectedBlockId) {
            // Находим выбранный блок
            const selectedBlock = currentCategories.find(block => block._id === selectedBlockId);
            if (selectedBlock) {
              loadSubcategories(selectedBlockId, selectedBlock.name);
            }
          } else {
            hideSubcategories();
          }
        });
      }

      // Обработчик выбора подкатегории
      if (subcategorySelect) {
        subcategorySelect.addEventListener('change', function() {
          const selectedCategoryId = this.value;
          const selectedCategoryName = this.options[this.selectedIndex].text;

          if (selectedCategoryId) {
            // Добавляем выбранную подкатегорию в основной селектор, если её там нет
            let optionExists = false;
            for (let i = 0; i < categorySelect.options.length; i++) {
              if (categorySelect.options[i].value === selectedCategoryId) {
                optionExists = true;
                break;
              }
            }

            if (!optionExists) {
              const newOption = document.createElement('option');
              newOption.value = selectedCategoryId;
              newOption.textContent = selectedCategoryName;
              categorySelect.appendChild(newOption);
            }

            // Выбираем подкатегорию в основном селекторе
            categorySelect.value = selectedCategoryId;
          }
        });
      }

      // Обработчик кнопки "Назад к блокам"
      if (backToBlocksBtn) {
        backToBlocksBtn.addEventListener('click', function(e) {
          e.stopPropagation();
          hideSubcategories();
          categorySelect.value = '';
        });
      }
    });

    // Обработка кнопок редактирования и удаления карточек
    document.addEventListener('click', (e) => {
      // Редактирование
      if (e.target.classList.contains('edit-product-btn') ||
          e.target.classList.contains('edit-service-btn') ||
          e.target.classList.contains('edit-banner-btn')) {
        const id = e.target.getAttribute('data-id');
        const isBanner = e.target.classList.contains('edit-banner-btn');
        const url = isBanner ? `/cabinet/banner/${id}/edit` : `/cabinet/product/${id}/edit`;
        window.location.href = url;
      }

      // Удаление
      if (e.target.classList.contains('delete-product-btn') ||
          e.target.classList.contains('delete-service-btn') ||
          e.target.classList.contains('delete-banner-btn')) {
        const id = e.target.getAttribute('data-id');
        const isBanner = e.target.classList.contains('delete-banner-btn');
        const type = isBanner ? 'баннер' : 'карточку';

        if (confirm(`Вы уверены, что хотите удалить эту ${type}?`)) {
          const url = isBanner ? `/cabinet/banner/${id}` : `/cabinet/product/${id}`;
          fetch(url, {
            method: 'DELETE',
            headers: {
              'X-CSRF-Token': document.querySelector('meta[name="csrf-token"]')?.getAttribute('content') || ''
            },
            credentials: 'same-origin'
          })
          .then(res => res.json())
          .then(data => {
            if (data.success) {
              location.reload();
            } else {
              alert('Ошибка удаления: ' + (data.message || 'Неизвестная ошибка'));
            }
          })
          .catch(err => {
            console.error('Ошибка:', err);
            alert('Ошибка сети');
          });
        }
      }
    });
  </script>

  <!-- Загрузка YouTube IFrame API -->
  <script>
    var tag = document.createElement('script');
    tag.src = "https://www.youtube.com/iframe_api";
    var firstScriptTag = document.getElementsByTagName('script')[0];
    firstScriptTag.parentNode.insertBefore(tag, firstScriptTag);
  </script>


  <!-- Bootstrap script for safe EJS → JS data transfer -->
  <script src="/utils/bootstrap.js"></script>
  <script>
    // Safe initialization of global variables
    window.AppBootstrap.init(<%- JSON.stringify({
      isAuth: true,
      isAdmin: typeof isAdmin !== 'undefined' ? isAdmin : false,
      socketIoAvailable: typeof socket_io_available !== 'undefined' ? socket_io_available : false,
      userRole: typeof userRole !== 'undefined' ? userRole : null
    }) %>);
  </script>

<% if (!process.env.VERCEL) { %>
<!-- Socket.IO -->
<script src="/socket.io/socket.io.js"></script>
<% } %>

</body>
</html>
