<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>–ê–¥–º–∏–Ω–∫–∞ ‚Äî –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∫–æ–Ω—Ç–∞–∫—Ç–∞–º–∏</title>
 <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="/styles.css?v=1.0.1">
</head>
<body class="admin-page">
  <div id="bg-animated" aria-hidden="true"></div>
  <header class="main-header">
    <div class="container header-inner">
      <div class="header-top">
        <div class="header-left">
          <a class="logo" href="/"><img src="/albamount.png" alt="ALBAMOUNT" class="logo-img"></a>
          <div class="header-stats">
            <div class="stat-item">
              <span style="opacity: 0.8;">üë•</span>
              <strong style="color: #4caf50;"><%= typeof visitorCount !== 'undefined' ? visitorCount : 0 %></strong>
            </div>
            <div class="stat-item">
              <span style="opacity: 0.8;">üë§</span>
              <strong style="color: #2196f3;"><%= typeof userCount !== 'undefined' ? userCount : 0 %></strong>
            </div>
          </div>
        </div>
        <div class="header-actions">
          <span class="user-chip">–ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å - –ö–æ–Ω—Ç–∞–∫—Ç—ã</span>
          <a href="/admin" class="btn outline small" style="margin-right: 10px;">–ù–∞–∑–∞–¥</a>
          <form id="logoutForm" method="POST" action="/logout" style="display:inline;">
            <button type="submit" class="btn outline small">–í—ã—Ö–æ–¥</button>
          </form>
        </div>
      </div>
    </div>
  </header>

  <main style="margin-bottom: 64px;">
    <!-- –î–æ–±–∞–≤–∏—Ç—å –∫–æ–Ω—Ç–∞–∫—Ç -->
    <section class="section">
      <div class="section-header">
        <h2>–î–æ–±–∞–≤–∏—Ç—å –∫–æ–Ω—Ç–∞–∫—Ç</h2>
      </div>
      <form id="addContactForm" class="form-grid">
        <input type="hidden" name="_csrf" value="<%= typeof csrfToken !== 'undefined' ? csrfToken : '' %>">
        <select name="type" required>
          <option value="">–í—ã–±–µ—Ä–∏—Ç–µ —Ç–∏–ø</option>
          <option value="admin">–ê–¥–º–∏–Ω</option>
          <option value="founder">–û—Å–Ω–æ–≤–∞—Ç–µ–ª—å</option>
          <option value="service">–°–ª—É–∂–±–∞ –ø–æ–¥–¥–µ—Ä–∂–∫–∏</option>
        </select>
        <input type="email" name="email" placeholder="Email" required>
        <input type="tel" name="phone" placeholder="–¢–µ–ª–µ—Ñ–æ–Ω">
        <textarea name="description" placeholder="–û–ø–∏—Å–∞–Ω–∏–µ" rows="3"></textarea>
        <button type="submit" class="btn primary">–î–æ–±–∞–≤–∏—Ç—å –∫–æ–Ω—Ç–∞–∫—Ç</button>
      </form>
      <div id="addContactMsg" class="note" style="margin-top:10px;"></div>
    </section>

    <!-- –ö–∞—Ç–∞–ª–æ–≥ –∫–æ–Ω—Ç–∞–∫—Ç–æ–≤ -->
    <section class="section">
      <div class="section-header">
        <h2>–ö–∞—Ç–∞–ª–æ–≥ –∫–æ–Ω—Ç–∞–∫—Ç–æ–≤</h2>
        <span class="badge" style="background:#666;color:#fff;padding:4px 12px;border-radius:6px;font-size:0.9rem;">
          –í—Å–µ–≥–æ: <%= contacts ? contacts.length : 0 %>
        </span>
      </div>

      <% if (contacts && contacts.length) { %>
        <div class="product-grid">
          <% contacts.forEach(c => { %>
            <div class="product-card">
              <h3 class="product-title"><%= c.type.charAt(0).toUpperCase() + c.type.slice(1) %></h3>
              
              <div class="product-bottom">
                <p class="product-desc">
                  <strong>Email:</strong> <a href="mailto:<%= c.email %>"><%= c.email %></a>
                </p>
                
                <% if (c.phone) { %>
                  <p class="product-desc">
                    <strong>–¢–µ–ª–µ—Ñ–æ–Ω:</strong> <%= c.phone %>
                  </p>
                <% } %>
                
                <% if (c.description) { %>
                  <p class="product-desc">
                    <strong>–û–ø–∏—Å–∞–Ω–∏–µ:</strong> <%= c.description %>
                  </p>
                <% } %>
                
                <p class="muted" style="text-align:center;font-size:0.85rem;margin-top:5px;">
                  –û–±–Ω–æ–≤–ª–µ–Ω–æ: <%= new Date(c.updatedAt).toLocaleString('ru-RU') %>
                </p>
                
                <div class="product-actions" style="flex-direction:column;gap:6px;margin-top:10px;">
                  <button class="btn small edit-btn" 
                          data-id="<%= c._id %>" 
                          data-type="<%= c.type %>" 
                          data-email="<%= c.email %>" 
                          data-phone="<%= c.phone || '' %>" 
                          data-description="<%= c.description || '' %>">
                    ‚úèÔ∏è –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å
                  </button>
                  
                  <form method="POST" action="/admin/contacts/<%= c._id %>/delete" style="display:inline" onsubmit="return confirm('–£–¥–∞–ª–∏—Ç—å –∫–æ–Ω—Ç–∞–∫—Ç?');">
                    <input type="hidden" name="_csrf" value="<%= typeof csrfToken !== 'undefined' ? csrfToken : '' %>">
                    <button type="submit" class="btn small outline" style="width:100%;">üóëÔ∏è –£–¥–∞–ª–∏—Ç—å</button>
                  </form>
                </div>
              </div>
            </div>
          <% }) %>
        </div>
      <% } else { %>
        <p class="empty-state">–ü–æ–∫–∞ –Ω–µ—Ç –∫–æ–Ω—Ç–∞–∫—Ç–æ–≤</p>
      <% } %>
    </section>
 </main>

  <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è -->
  <div id="editModal" class="modal" aria-hidden="true" style="display:none;">
    <div class="modal-content" role="dialog" aria-modal="true" aria-label="–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –∫–æ–Ω—Ç–∞–∫—Ç">
      <button class="close" data-close-edit aria-label="–ó–∞–∫—Ä—ã—Ç—å">&times;</button>
      <h3>–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –∫–æ–Ω—Ç–∞–∫—Ç</h3>
      <form id="editContactForm">
        <input type="hidden" name="_csrf" value="<%= typeof csrfToken !== 'undefined' ? csrfToken : '' %>">
        <input type="hidden" id="editContactId" name="id">
        <select id="editContactType" name="type" required>
          <option value="admin">–ê–¥–º–∏–Ω</option>
          <option value="founder">–û—Å–Ω–æ–≤–∞—Ç–µ–ª—å</option>
          <option value="service">–°–ª—É–∂–±–∞ –ø–æ–¥–¥–µ—Ä–∂–∫–∏</option>
        </select>
        <input type="email" id="editContactEmail" name="email" placeholder="Email" required>
        <input type="tel" id="editContactPhone" name="phone" placeholder="–¢–µ–ª–µ—Ñ–æ–Ω">
        <textarea id="editContactDescription" name="description" placeholder="–û–ø–∏—Å–∞–Ω–∏–µ" rows="3"></textarea>
        <button type="submit" class="btn" style="margin-top:10px;">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
      </form>
    </div>
  </div>


  <!-- –ü–µ—Ä–µ–¥–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ Socket.IO –Ω–∞ –∫–ª–∏–µ–Ω—Ç -->
  <!-- Bootstrap script for safe EJS ‚Üí JS data transfer -->
  <script src="/utils/bootstrap.js"></script>
  <script>
    // Safe initialization of global variables
    window.AppBootstrap.init(<%- JSON.stringify({
      isAuth: true,
      isAdmin: true,
      socketIoAvailable: typeof socket_io_available !== 'undefined' ? socket_io_available : false,
      userRole: typeof userRole !== 'undefined' ? userRole : 'admin'
    }) %>);
  </script>

  <script>
    // –ì–ª–æ–±–∞–ª—å–Ω—ã–π CSRF —Ç–æ–∫–µ–Ω
    const CSRF_TOKEN = "<%- typeof csrfToken !== 'undefined' ? csrfToken : '' %>";

    // Helper —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è POST –∑–∞–ø—Ä–æ—Å–æ–≤ —Å CSRF
    async function postJSON(url, data = {}) {
      return fetch(url, {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "X-CSRF-Token": CSRF_TOKEN
        },
        body: JSON.stringify(data)
      });
    }

    document.addEventListener("DOMContentLoaded", () => {

      // –û–±—Ä–∞–±–æ—Ç–∫–∞ –≤—ã—Ö–æ–¥–∞
      const logoutForm = document.getElementById("logoutForm");
      if (logoutForm) {
        logoutForm.addEventListener("submit", async (e) => {
          e.preventDefault();
          if (!confirm("–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –≤—ã–π—Ç–∏?")) return;
          try {
            const res = await fetch("/logout", { method: "POST" });
            if (res.ok) {
              window.location.href = "/";
            }
          } catch (err) {
            window.location.href = "/";
          }
        });
      }

      // –û–±—Ä–∞–±–æ—Ç–∫–∞ —Ñ–æ—Ä–º—ã –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –∫–æ–Ω—Ç–∞–∫—Ç–∞
      const addContactForm = document.getElementById('addContactForm');
      const addContactMsg = document.getElementById('addContactMsg');

      if (addContactForm) {
        addContactForm.addEventListener('submit', async function(e) {
          e.preventDefault();

          addContactMsg.textContent = '–û—Ç–ø—Ä–∞–≤–∫–∞...';
          addContactMsg.style.color = '#666';

          const formData = new FormData(addContactForm);
          const contactData = Object.fromEntries(formData.entries());

          try {
            const res = await postJSON('/admin/contacts/create', contactData);
            const data = await res.json();
            
            if (data.success) {
              addContactMsg.textContent = '–ö–æ–Ω—Ç–∞–∫—Ç —É—Å–ø–µ—à–Ω–æ –¥–æ–±–∞–≤–ª–µ–Ω!';
              addContactMsg.style.color = 'green';
              addContactForm.reset();
              setTimeout(() => {
                location.reload();
              }, 1500);
            } else {
              addContactMsg.textContent = data.message || '–û—à–∏–±–∫–∞ –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ –∫–æ–Ω—Ç–∞–∫—Ç–∞';
              addContactMsg.style.color = '#b00020';
            }
          } catch (err) {
            addContactMsg.textContent = '–û—à–∏–±–∫–∞ —Å–µ—Ç–∏: ' + err.message;
            addContactMsg.style.color = '#b00020';
          }
        });
      }

      // –û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–Ω–æ–ø–æ–∫ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
      const editBtns = document.querySelectorAll('.edit-btn');
      const editModal = document.getElementById('editModal');
      const editContactForm = document.getElementById('editContactForm');
      const editContactId = document.getElementById('editContactId');
      const editContactType = document.getElementById('editContactType');
      const editContactEmail = document.getElementById('editContactEmail');
      const editContactPhone = document.getElementById('editContactPhone');
      const editContactDescription = document.getElementById('editContactDescription');

      editBtns.forEach(btn => {
        btn.addEventListener('click', () => {
          // –ó–∞–ø–æ–ª–Ω—è–µ–º —Ñ–æ—Ä–º—É –¥–∞–Ω–Ω—ã–º–∏ –∫–æ–Ω—Ç–∞–∫—Ç–∞
          editContactId.value = btn.getAttribute('data-id');
          editContactType.value = btn.getAttribute('data-type');
          editContactEmail.value = btn.getAttribute('data-email');
          editContactPhone.value = btn.getAttribute('data-phone');
          editContactDescription.value = btn.getAttribute('data-description');
          
          // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ
          editModal.style.display = 'block';
          editModal.setAttribute('aria-hidden', 'false');
        });
      });

      // –ó–∞–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞
      const closeEditBtn = document.querySelector("[data-close-edit]");
      if (closeEditBtn) {
        closeEditBtn.addEventListener('click', () => {
          editModal.style.display = 'none';
          editModal.setAttribute('aria-hidden', 'true');
        });
      }

      // –û–±—Ä–∞–±–æ—Ç–∫–∞ —Ñ–æ—Ä–º—ã —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
      if (editContactForm) {
        editContactForm.addEventListener('submit', async function(e) {
          e.preventDefault();

          const formData = new FormData(editContactForm);
          const contactData = Object.fromEntries(formData.entries());

          try {
            const res = await postJSON(`/admin/contacts/${contactData.id}/update`, {
              type: contactData.type,
              email: contactData.email,
              phone: contactData.phone,
              description: contactData.description
            });
            const data = await res.json();
            
            if (data.success) {
              alert('–ö–æ–Ω—Ç–∞–∫—Ç —É—Å–ø–µ—à–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω!');
              location.reload();
            } else {
              alert(data.message || '–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ –∫–æ–Ω—Ç–∞–∫—Ç–∞');
            }
          } catch (err) {
            alert('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏: ' + err.message);
          }
        });
      }

      // –ó–∞–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –ø—Ä–∏ –∫–ª–∏–∫–µ –≤–Ω–µ –µ–≥–æ
      window.addEventListener('click', (e) => {
        if (e.target === editModal) {
          editModal.style.display = 'none';
          editModal.setAttribute('aria-hidden', 'true');
        }
      });
    });
  </script>

  <style>
    .modal {
      display: none;
      position: fixed;
      z-index: 2000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0,0,0,0.8);
    }
    .modal-content {
      background-color: #1a1a1a;
      margin: 5% auto;
      padding: 20px;
      border: 1px solid #444;
      border-radius: 12px;
      width: 90%;
      max-width: 600px;
      position: relative;
    }
    .close {
      color: #aaa;
      float: right;
      font-size: 28px;
      font-weight: bold;
      cursor: pointer;
      background: none;
      border: none;
      position: absolute;
      right: 15px;
      top: 10px;
    }
    .close:hover {
      color: #fff;
    }
  </style>
  </body>
  </html>
