<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º–∏</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="csrf-token" content="<%= csrfToken %>">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="/styles.css?v=1.0.1">
  <style>
    .category-tree {
      margin: 20px 0;
    }
    .category-item {
      margin: 10px 0;
      padding: 10px;
      border: 1px solid #ddd;
      border-radius: 8px;
      background: #f9f9f9;
    }
    .category-item.level-1 { margin-left: 20px; }
    .category-item.level-2 { margin-left: 40px; }
    .category-item.level-3 { margin-left: 60px; }
    .category-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .category-actions {
      display: flex;
      gap: 10px;
    }
    .modal {
      display: none;
      position: fixed;
      z-index: 1000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0,0,0,0.4);
    }
    .modal-content {
      background-color: #fefefe;
      margin: 15% auto;
      padding: 20px;
      border: 1px solid #888;
      width: 90%;
      max-width: 500px;
      border-radius: 8px;
    }
    .form-group {
      margin-bottom: 15px;
    }
    .form-group label {
      display: block;
      margin-bottom: 5px;
      font-weight: 600;
    }
    .form-group input, .form-group select, .form-group textarea {
      width: 100%;
      padding: 8px;
      border: 1px solid #ddd;
      border-radius: 4px;
    }
    .btn-group {
      display: flex;
      gap: 10px;
      justify-content: flex-end;
      margin-top: 20px;
    }
  </style>
</head>
<body>
  <div id="bg-animated" aria-hidden="true"></div>
  <header class="main-header">
    <div class="container header-inner">
      <a class="logo" href="/"><img src="/albamount.png" alt="ALBAMOUNT" class="logo-img"></a>
      <nav class="nav">
        <ul class="nav-list">
          <li><a class="nav-link" href="/admin">–ì–ª–∞–≤–Ω–∞—è</a></li>
          <li><a class="nav-link active" href="/admin/categories">–ö–∞—Ç–µ–≥–æ—Ä–∏–∏</a></li>
        </ul>
      </nav>
      <div class="header-actions">
        <a class="btn outline" href="/admin">‚Üê –ù–∞–∑–∞–¥</a>
      </div>
    </div>
  </header>

  <main class="container">
    <section class="section">
      <div class="section-header">
        <h2>–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º–∏</h2>
        <button class="btn primary" onclick="openCreateModal()">+ –î–æ–±–∞–≤–∏—Ç—å –∫–∞—Ç–µ–≥–æ—Ä–∏—é</button>
      </div>

      <div class="tabs">
        <button class="tab active" data-type="product">–¢–æ–≤–∞—Ä—ã</button>
        <button class="tab" data-type="service">–£—Å–ª—É–≥–∏</button>
        <button class="tab" data-type="banner">–ë–∞–Ω–Ω–µ—Ä—ã</button>
        <button class="tab" data-type="all">–í—Å–µ</button>
      </div>

      <div class="tab-content active" id="categories-product">
        <h3>–ö–∞—Ç–µ–≥–æ—Ä–∏–∏ —Ç–æ–≤–∞—Ä–æ–≤</h3>
        <div id="tree-product" class="category-tree">
          <!-- –ö–∞—Ç–µ–≥–æ—Ä–∏–∏ —Ç–æ–≤–∞—Ä–æ–≤ –±—É–¥—É—Ç –∑–∞–≥—Ä—É–∂–µ–Ω—ã —á–µ—Ä–µ–∑ JavaScript -->
        </div>
      </div>

      <div class="tab-content" id="categories-service">
        <h3>–ö–∞—Ç–µ–≥–æ—Ä–∏–∏ —É—Å–ª—É–≥</h3>
        <div id="tree-service" class="category-tree">
          <!-- –ö–∞—Ç–µ–≥–æ—Ä–∏–∏ —É—Å–ª—É–≥ –±—É–¥—É—Ç –∑–∞–≥—Ä—É–∂–µ–Ω—ã —á–µ—Ä–µ–∑ JavaScript -->
        </div>
      </div>

      <div class="tab-content" id="categories-banner">
        <h3>–ö–∞—Ç–µ–≥–æ—Ä–∏–∏ –±–∞–Ω–Ω–µ—Ä–æ–≤</h3>
        <div id="tree-banner" class="category-tree">
          <!-- –ö–∞—Ç–µ–≥–æ—Ä–∏–∏ –±–∞–Ω–Ω–µ—Ä–æ–≤ –±—É–¥—É—Ç –∑–∞–≥—Ä—É–∂–µ–Ω—ã —á–µ—Ä–µ–∑ JavaScript -->
        </div>
      </div>

      <div class="tab-content" id="categories-all">
        <h3>–í—Å–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏</h3>
        <div id="tree-all" class="category-tree">
          <!-- –í—Å–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ –±—É–¥—É—Ç –∑–∞–≥—Ä—É–∂–µ–Ω—ã —á–µ—Ä–µ–∑ JavaScript -->
        </div>
      </div>
    </section>
  </main>

  <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —Å–æ–∑–¥–∞–Ω–∏—è/—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ -->
  <div id="categoryModal" class="modal">
    <div class="modal-content">
      <h3 id="modalTitle">–°–æ–∑–¥–∞—Ç—å –∫–∞—Ç–µ–≥–æ—Ä–∏—é</h3>
      <form id="categoryForm">
        <input type="hidden" id="categoryId" name="categoryId">
        <input type="hidden" name="_csrf" value="<%= csrfToken %>">

        <div class="form-group">
          <label for="categoryName">–ù–∞–∑–≤–∞–Ω–∏–µ:</label>
          <input type="text" id="categoryName" name="name" required>
        </div>

        <div class="form-group">
          <label for="categoryType">–¢–∏–ø:</label>
          <select id="categoryType" name="type" required>
            <option value="product">–¢–æ–≤–∞—Ä—ã</option>
            <option value="service">–£—Å–ª—É–≥–∏</option>
            <option value="banner">–ë–∞–Ω–Ω–µ—Ä—ã</option>
            <option value="all">–í—Å–µ</option>
          </select>
        </div>

        <div class="form-group">
          <label for="categoryParent">–†–æ–¥–∏—Ç–µ–ª—å—Å–∫–∞—è –∫–∞—Ç–µ–≥–æ—Ä–∏—è:</label>
          <select id="categoryParent" name="parentId">
            <option value="">–ù–µ—Ç —Ä–æ–¥–∏—Ç–µ–ª—è</option>
            <!-- –û–ø—Ü–∏–∏ –±—É–¥—É—Ç –∑–∞–≥—Ä—É–∂–µ–Ω—ã –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ -->
          </select>
        </div>

        <div class="form-group">
          <label for="categoryIcon">–ò–∫–æ–Ω–∫–∞ (emoji):</label>
          <input type="text" id="categoryIcon" name="icon" placeholder="üè†">
        </div>

        <div class="form-group">
          <label for="categoryDescription">–û–ø–∏—Å–∞–Ω–∏–µ:</label>
          <textarea id="categoryDescription" name="description" rows="3"></textarea>
        </div>

        <div class="form-group">
          <label for="categoryOrder">–ü–æ—Ä—è–¥–æ–∫ —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏:</label>
          <input type="number" id="categoryOrder" name="order" value="0">
        </div>

        <div class="btn-group">
          <button type="button" class="btn outline" onclick="closeModal()">–û—Ç–º–µ–Ω–∞</button>
          <button type="submit" class="btn primary">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
        </div>
      </form>
    </div>
  </div>

  <script>
    let currentType = 'product';
    let categoriesData = {};

    // –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –≤–∫–ª–∞–¥–æ–∫
    document.addEventListener('DOMContentLoaded', () => {
      const tabs = document.querySelectorAll('.tab');
      tabs.forEach(tab => {
        tab.addEventListener('click', () => {
          const type = tab.dataset.type;
          switchTab(type);
        });
      });

      // –ó–∞–≥—Ä—É–∂–∞–µ–º –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ –¥–ª—è –∞–∫—Ç–∏–≤–Ω–æ–π –≤–∫–ª–∞–¥–∫–∏
      loadCategories(currentType);

      // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ —Ñ–æ—Ä–º—ã
      document.getElementById('categoryForm').addEventListener('submit', handleFormSubmit);
    });

    function switchTab(type) {
      currentType = type;

      // –ü–µ—Ä–µ–∫–ª—é—á–∞–µ–º –∞–∫—Ç–∏–≤–Ω—ã–µ –≤–∫–ª–∞–¥–∫–∏
      document.querySelectorAll('.tab').forEach(tab => {
        tab.classList.remove('active');
        if (tab.dataset.type === type) {
          tab.classList.add('active');
        }
      });

      // –ü–µ—Ä–µ–∫–ª—é—á–∞–µ–º –∫–æ–Ω—Ç–µ–Ω—Ç
      document.querySelectorAll('.tab-content').forEach(content => {
        content.classList.remove('active');
        if (content.id === `categories-${type}`) {
          content.classList.add('active');
        }
      });

      // –ó–∞–≥—Ä—É–∂–∞–µ–º –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ –¥–ª—è –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ —Ç–∏–ø–∞
      loadCategories(type);
    }

    async function loadCategories(type) {
      try {
        const response = await fetch(`/api/categories/tree/${type}`);
        const data = await response.json();

        if (data.success) {
          categoriesData[type] = data.categories;
          renderCategoryTree(type, data.categories);
        } else {
        }
      } catch (error) {
      }
    }

    function renderCategoryTree(type, categories) {
      const container = document.getElementById(`tree-${type}`);
      container.innerHTML = '';

      function renderItems(items, level = 0) {
        items.forEach(category => {
          const item = document.createElement('div');
          item.className = `category-item level-${level}`;
          item.style.marginLeft = `${level * 20}px`;
          item.innerHTML = `
            <div class="category-header">
              <div>
                <strong>${category.icon || ''} ${category.name}</strong>
                <span class="category-level-indicator">${level === 0 ? '–ë–ª–æ–∫' : level === 1 ? '–ö–∞—Ç–µ–≥–æ—Ä–∏—è' : '–ü–æ–¥–∫–∞—Ç–µ–≥–æ—Ä–∏—è'}</span>
                ${category.description ? `<br><small>${category.description}</small>` : ''}
              </div>
              <div class="category-actions">
                <button class="btn small outline" onclick="editCategory('${category._id}')">‚úèÔ∏è</button>
                <button class="btn small outline" onclick="addSubcategory('${category._id}')">+</button>
                <button class="btn small danger" onclick="deleteCategory('${category._id}', '${category.name}')">üóëÔ∏è</button>
              </div>
            </div>
          `;
          container.appendChild(item);

          if (category.children && category.children.length > 0) {
            renderItems(category.children, level + 1);
          }
        });
      }

      if (categories.length === 0) {
        container.innerHTML = '<p>–ö–∞—Ç–µ–≥–æ—Ä–∏–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã. –°–æ–∑–¥–∞–π—Ç–µ –ø–µ—Ä–≤—É—é –∫–∞—Ç–µ–≥–æ—Ä–∏—é.</p>';
      } else {
        renderItems(categories);
      }
    }

    function openCreateModal() {
      document.getElementById('modalTitle').textContent = '–°–æ–∑–¥–∞—Ç—å –∫–∞—Ç–µ–≥–æ—Ä–∏—é';
      document.getElementById('categoryId').value = '';
      document.getElementById('categoryForm').reset();
      document.getElementById('categoryType').value = currentType === 'all' ? 'product' : currentType;
      loadParentOptions();
      document.getElementById('categoryModal').style.display = 'block';
    }

    function editCategory(id) {
      // –ù–∞–π—Ç–∏ –∫–∞—Ç–µ–≥–æ—Ä–∏—é –ø–æ ID
      function findCategory(items) {
        for (const item of items) {
          if (item._id === id) return item;
          if (item.children) {
            const found = findCategory(item.children);
            if (found) return found;
          }
        }
        return null;
      }

      const category = findCategory(categoriesData[currentType]);
      if (!category) return;

      document.getElementById('modalTitle').textContent = '–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –∫–∞—Ç–µ–≥–æ—Ä–∏—é';
      document.getElementById('categoryId').value = category._id;
      document.getElementById('categoryName').value = category.name;
      document.getElementById('categoryType').value = category.type;
      document.getElementById('categoryIcon').value = category.icon || '';
      document.getElementById('categoryDescription').value = category.description || '';
      document.getElementById('categoryOrder').value = category.order || 0;

      loadParentOptions(category.parentId);
      document.getElementById('categoryModal').style.display = 'block';
    }

    function addSubcategory(parentId) {
      document.getElementById('modalTitle').textContent = '–°–æ–∑–¥–∞—Ç—å –ø–æ–¥–∫–∞—Ç–µ–≥–æ—Ä–∏—é';
      document.getElementById('categoryId').value = '';
      document.getElementById('categoryForm').reset();
      document.getElementById('categoryType').value = currentType === 'all' ? 'product' : currentType;
      document.getElementById('categoryParent').value = parentId;
      loadParentOptions(parentId);
      document.getElementById('categoryModal').style.display = 'block';
    }

    function loadParentOptions(selectedParentId = '') {
      const parentSelect = document.getElementById('categoryParent');
      parentSelect.innerHTML = '<option value="">–ù–µ—Ç —Ä–æ–¥–∏—Ç–µ–ª—è</option>';

      function addOptions(items, prefix = '') {
        items.forEach(item => {
          const option = document.createElement('option');
          option.value = item._id;
          option.textContent = prefix + (item.icon || '') + ' ' + item.name;
          if (item._id === selectedParentId) {
            option.selected = true;
          }
          parentSelect.appendChild(option);

          if (item.children && item.children.length > 0) {
            addOptions(item.children, prefix + '‚Äî ');
          }
        });
      }

      if (categoriesData[currentType]) {
        addOptions(categoriesData[currentType]);
      }
    }

    function closeModal() {
      document.getElementById('categoryModal').style.display = 'none';
    }

    async function handleFormSubmit(e) {
      e.preventDefault();

      const formData = new FormData(e.target);
      const data = Object.fromEntries(formData.entries());
      const categoryId = data.categoryId;

      try {
        const url = categoryId ? `/api/categories/${categoryId}` : '/api/categories';
        const method = categoryId ? 'PUT' : 'POST';

        const response = await fetch(url, {
          method: method,
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify(data)
        });

        const result = await response.json();

        if (result.success) {
          closeModal();
          loadCategories(currentType);
          alert(result.message || '–ö–∞—Ç–µ–≥–æ—Ä–∏—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞');
        } else {
          alert('–û—à–∏–±–∫–∞: ' + result.message);
        }
      } catch (error) {
        alert('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏');
      }
    }

    async function deleteCategory(id, name) {
      if (!confirm(`–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å –∫–∞—Ç–µ–≥–æ—Ä–∏—é "${name}"?`)) {
        return;
      }

      try {
        const response = await fetch(`/api/categories/${id}`, {
          method: 'DELETE'
        });

        const result = await response.json();

        if (result.success) {
          loadCategories(currentType);
          alert('–ö–∞—Ç–µ–≥–æ—Ä–∏—è —É–¥–∞–ª–µ–Ω–∞');
        } else {
          alert('–û—à–∏–±–∫–∞: ' + result.message);
        }
      } catch (error) {
        alert('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏');
      }
    }

    // –ó–∞–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –ø–æ –∫–ª–∏–∫—É –≤–Ω–µ –µ–≥–æ
    window.onclick = function(event) {
      const modal = document.getElementById('categoryModal');
      if (event.target === modal) {
        closeModal();
      }
    }
  </script>
</body>
</html>
